<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BA Studio - Trợ lý AI cho sinh viên</title>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <!-- Libraries for file reading -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.7.0/mammoth.browser.min.js"></script>
    <!-- Thư viện Marked.js để xử lý Markdown -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        // Required setup for PDF.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js`;
    </script>
    <style>
        :root {
            --sidebar-bg: #1e293b;
            --main-bg: #f1f5f9;
            --text-light: #f8fafc;
            --text-dark: #334155;
            --accent-color: #3b82f6;
            --accent-hover: #2563eb;
            --user-message-bg: #e0f2fe;
            --ai-message-bg: #ffffff;
            --btn-secondary-bg: #e2e8f0;
            --danger-color: #ef4444;
            --danger-hover: #dc2626;
        }
        body { font-family: 'Inter', sans-serif; margin: 0; background-color: var(--main-bg); color: var(--text-dark); display: flex; height: 100vh; overflow: hidden; }
        #sidebar { width: 250px; background-color: var(--sidebar-bg); color: var(--text-light); padding: 20px 0; display: flex; flex-direction: column; flex-shrink: 0; }
        #sidebar-header { padding: 0 20px 20px 20px; font-size: 1.5rem; font-weight: bold; display: flex; align-items: center; gap: 10px; }
        .nav-list { list-style: none; padding: 0; margin: 0; flex-grow: 1; }
        .nav-item a { display: flex; align-items: center; gap: 15px; padding: 15px 20px; color: var(--text-light); text-decoration: none; font-size: 1rem; transition: background-color 0.2s, border-left 0.2s; border-left: 4px solid transparent; }
        .nav-item a:hover { background-color: #334155; }
        .nav-item a.active { background-color: #475569; border-left: 4px solid var(--accent-color); font-weight: 600; }
        .nav-icon { width: 20px; text-align: center; }
        #main-content { flex-grow: 1; padding: 30px; overflow-y: auto; }
        .module-content { display: none; }
        .module-content.active { display: block; }
        .module-header-wrapper { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .module-header { font-size: 2rem; font-weight: bold; color: var(--sidebar-bg); margin: 0; }
        .module-subheader { font-size: 1rem; color: #64748b; margin-bottom: 30px; }
        .controls-box, .chat-container, .response-box { width: 100%; max-width: 800px; background-color: #fff; padding: 25px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.05); }
        .markdown-content h1, .markdown-content h2, .markdown-content h3 { color: var(--sidebar-bg); margin-top: 1.5em; margin-bottom: 0.5em;}
        .markdown-content p { margin-bottom: 1em; }
        .markdown-content ul, .markdown-content ol { padding-left: 20px; }
        .markdown-content code { background-color: #e2e8f0; padding: 2px 4px; border-radius: 4px; font-family: 'Courier New', Courier, monospace; }
        .markdown-content pre { background-color: #e2e8f0; padding: 15px; border-radius: 8px; overflow-x: auto; }
        .markdown-content table { border-collapse: collapse; width: 100%; margin: 1em 0; }
        .markdown-content th, .markdown-content td { border: 1px solid #cbd5e1; padding: 8px; text-align: left; }
        .markdown-content th { background-color: #f1f5f9; }

        button { padding: 10px 20px; background-color: var(--accent-color); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 1rem; transition: background-color 0.3s ease; display: inline-flex; align-items: center; justify-content: center; gap: 8px; font-weight: 600; }
        button:hover { background-color: var(--accent-hover); }
        button:disabled { background-color: #93c5fd; cursor: not-allowed; }
        .btn-danger { background-color: var(--danger-color); }
        .btn-danger:hover { background-color: var(--danger-hover); }
        .btn-icon { padding: 8px 12px; }

        .chat-history { height: 500px; overflow-y: auto; border: 1px solid #e2e8f0; padding: 10px; border-radius: 8px; margin-bottom: 15px; display: flex; flex-direction: column; }
        .chat-message { padding: 10px 15px; border-radius: 12px; margin-bottom: 10px; max-width: 85%; line-height: 1.5; display: flex; align-items: flex-start; gap: 10px; }
        .user-message { background-color: var(--user-message-bg); align-self: flex-end; margin-left: auto; }
        .ai-message { background-color: var(--ai-message-bg); border: 1px solid #e2e8f0; align-self: flex-start; }
        .chat-message .message-text { flex-grow: 1; word-wrap: break-word; min-height: 1.5em; }
        .chat-message .message-text * { margin: 0; }

        .speak-btn { background: none; border: none; color: #64748b; cursor: pointer; padding: 0 5px; font-size: 1rem; opacity: 0.7; transition: opacity 0.2s; }
        .speak-btn:hover { opacity: 1; color: var(--accent-color); }
        .chat-input-form { display: flex; gap: 10px; }
        .chat-input-form input { flex-grow: 1; padding: 12px; border: 1px solid #cbd5e1; border-radius: 4px; font-size: 16px; }
        .large-spinner { width: 40px; height: 40px; border: 5px solid #e2e8f0; border-radius: 50%; border-top-color: var(--accent-color); margin: auto; animation: spin 1s linear infinite; }
        .setup-group { margin-bottom: 25px; }
        .setup-label { font-weight: 600; display: block; margin-bottom: 10px; }
        .btn-group { display: flex; flex-wrap: wrap; gap: 10px; }
        .btn-group button { background-color: var(--btn-secondary-bg); color: var(--text-dark); }
        .btn-group button.selected { background-color: var(--accent-color); color: white; }
        .file-upload-wrapper { cursor: pointer; border: 2px dashed #cbd5e1; padding: 30px; text-align: center; border-radius: 8px; transition: background-color 0.2s; display: block;}
        .file-upload-wrapper:hover { background-color: #f8fafc;}
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <aside id="sidebar">
        <div id="sidebar-header"><i class="fa-solid fa-brain"></i><span>BA Studio</span></div>
        <ul class="nav-list">
            <li class="nav-item"><a href="#learning-room" class="nav-link"><i class="fa-solid fa-book-open nav-icon"></i> <span>BA Learning Room</span></a></li>
            <li class="nav-item"><a href="#case-trainer" class="nav-link"><i class="fa-solid fa-chart-simple nav-icon"></i> <span>AI Case Trainer</span></a></li>
            <li class="nav-item"><a href="#mock-interview" class="nav-link"><i class="fa-solid fa-microphone nav-icon"></i> <span>Mock Interview</span></a></li>
        </ul>
    </aside>

    <main id="main-content">
        <!-- Module 1: BA Learning Room -->
        <div id="learning-room" class="module-content">
             <div class="module-header-wrapper">
                <h1 class="module-header">BA Learning Room</h1>
                <button id="clear-learning-history" class="btn-icon btn-danger" title="Bắt đầu lại"><i class="fa-solid fa-trash-can"></i></button>
             </div>
             <p class="module-subheader">Trò chuyện với trợ lý AI để tìm hiểu sâu về các khái niệm Business Analytics.</p>
             <div class="chat-container">
                <div class="chat-history" id="learning-chat-history">
                    <!-- Chat history will be loaded here -->
                </div>
                <form id="learning-chat-form" class="chat-input-form">
                    <input type="text" id="learning-chat-input" placeholder="Ví dụ: Giải thích về A/B Testing..." autocomplete="off">
                    <button type="submit">Gửi</button>
                </form>
             </div>
        </div>

        <!-- Module 2: AI Case Trainer -->
        <div id="case-trainer" class="module-content">
             <div class="module-header-wrapper">
                 <h1 class="module-header">AI Case Trainer</h1>
                 <button id="clear-case-trainer-history" class="btn-icon btn-danger" title="Bắt đầu lại"><i class="fa-solid fa-trash-can"></i></button>
             </div>
             <p class="module-subheader">Bắt đầu một phiên phân tích bằng cách tải lên file dữ liệu.</p>
             <div id="file-upload-section" class="controls-box">
                <label for="fileInput" class="file-upload-wrapper"><i class="fa-solid fa-cloud-arrow-up"></i> <span id="file-upload-text">Nhấp để chọn file CSV, Excel, PDF hoặc DOCX</span></label>
                <input type="file" id="fileInput" accept=".csv, .xlsx, .xls, .pdf, .docx" style="display: none;">
                <button id="analyzeFileButton" disabled><span>Bắt đầu Phân tích Mới</span></button>
             </div>
             <div id="case-trainer-chat-section" class="chat-container" style="display: none;">
                <div class="chat-history" id="case-trainer-chat-history"></div>
                <form id="case-trainer-chat-form" class="chat-input-form">
                    <input type="text" id="case-trainer-chat-input" placeholder="Đặt câu hỏi về tài liệu của bạn..." autocomplete="off">
                    <button type="submit">Gửi</button>
                </form>
             </div>
        </div>
        
        <!-- Module 3: Mock Interview -->
        <div id="mock-interview" class="module-content">
            <div class="module-header-wrapper">
                 <h1 class="module-header">Mock Interview</h1>
                 <button id="clear-interview-history" class="btn-icon btn-danger" title="Bắt đầu lại"><i class="fa-solid fa-trash-can"></i></button>
            </div>
             <p class="module-subheader">Luyện tập phỏng vấn với nhà tuyển dụng AI.</p>
             <div id="interview-setup-section" class="controls-box">
                <div class="setup-group"><span class="setup-label">1. Chọn ngôn ngữ:</span><div id="language-btn-group" class="btn-group"><button class="language-btn selected" data-lang="vietnamese">Tiếng Việt</button><button class="language-btn" data-lang="english">English</button></div></div>
                <div class="setup-group"><span class="setup-label">2. Chọn chủ đề:</span><div id="topic-btn-group" class="btn-group"><button class="topic-btn" data-topic="Business Case">Tình huống Kinh doanh</button><button class="topic-btn" data-topic="SQL">Kiến thức SQL</button><button class="topic-btn" data-topic="Storytelling">Kể chuyện bằng Dữ liệu</button></div></div>
                <button id="startInterviewButton" disabled>Bắt đầu Phỏng vấn</button>
             </div>
             <div id="interview-chat-section" class="chat-container" style="display: none;">
                <div class="chat-history" id="interview-chat-history"></div>
                <form id="interview-chat-input-form" class="chat-input-form"><input type="text" id="interview-chat-input" placeholder="Nhập câu trả lời của bạn..." autocomplete="off"><button type="submit">Gửi</button></form>
             </div>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-app.js";
        import { getAI, getGenerativeModel, GoogleAIBackend } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-ai.js";
        
        window.addEventListener('DOMContentLoaded', () => {
            // --- 1. INITIALIZE FIREBASE & AI MODEL ---
            const firebaseConfig = {
                apiKey: "AIzaSyAP6gEJJrq0YE0lzYT-EeuskY0C1XHP9wo",
                authDomain: "bawithai.firebaseapp.com",
                projectId: "bawithai",
                storageBucket: "bawithai.appspot.com",
                messagingSenderId: "75283657811",
                appId: "1:75283657811:web:9c5c3e778396b9a340c2a6"
            };
            const app = initializeApp(firebaseConfig);
            let geminiModel;
            try {
                const ai = getAI(app, { backend: new GoogleAIBackend() });
                geminiModel = getGenerativeModel(ai, { model: "gemini-1.5-flash-latest" });
            } catch (e) { console.error("Error initializing AI Model:", e); }

            // --- 2. SETUP NAVIGATION ---
            const navLinks = document.querySelectorAll('.nav-link');
            const moduleContents = document.querySelectorAll('.module-content');
            function showModule(hash) {
                const targetId = hash.substring(1);
                navLinks.forEach(link => link.classList.toggle('active', link.hash === hash));
                moduleContents.forEach(content => content.classList.toggle('active', content.id === targetId));
            }
            navLinks.forEach(link => {
                link.addEventListener('click', (e) => { e.preventDefault(); window.history.pushState(null, '', e.currentTarget.hash); showModule(e.currentTarget.hash); });
            });
            window.addEventListener('popstate', () => { showModule(window.location.hash || '#learning-room'); });
            
            // --- GENERIC HELPER FUNCTIONS ---
            async function streamResponseToElement(element, resultStream) {
                let fullResponseText = "";
                for await (const chunk of resultStream) {
                    fullResponseText += chunk.text();
                    element.innerHTML = marked.parse(fullResponseText);
                    const chatContainer = element.closest('.chat-history');
                    if (chatContainer) chatContainer.scrollTop = chatContainer.scrollHeight;
                }
                return fullResponseText;
            }

            function saveToLocalStorage(key, data) {
                localStorage.setItem(key, JSON.stringify(data));
            }

            function loadFromLocalStorage(key) {
                const data = localStorage.getItem(key);
                return data ? JSON.parse(data) : null;
            }

            // --- 3. "BA LEARNING ROOM" LOGIC ---
            const learningChatHistoryEl = document.getElementById('learning-chat-history');
            const learningChatForm = document.getElementById('learning-chat-form');
            const learningChatInput = document.getElementById('learning-chat-input');
            const clearLearningHistoryBtn = document.getElementById('clear-learning-history');
            let learningHistory = [];
            let learningChatSession = null;

            function addLearningMessage(sender, text, isHTML = false) {
                const messageDiv = document.createElement('div');
                messageDiv.classList.add('chat-message', sender === 'user' ? 'user-message' : 'ai-message');
                const textSpan = document.createElement('span');
                textSpan.classList.add('message-text');
                if (isHTML) {
                    textSpan.innerHTML = text;
                } else {
                    textSpan.textContent = text;
                }
                messageDiv.appendChild(textSpan);
                learningChatHistoryEl.appendChild(messageDiv);
                learningChatHistoryEl.scrollTop = learningChatHistoryEl.scrollHeight;
                return textSpan;
            }
            
            function resetLearningSession() {
                localStorage.removeItem('learningHistory');
                learningHistory = [];
                learningChatSession = null;
                learningChatHistoryEl.innerHTML = '';
                addLearningMessage('ai', "Xin chào! Tôi là trợ lý học tập BA của bạn. Bạn muốn hỏi về chủ đề gì hôm nay?", true);
            }

            function loadLearningHistory() {
                learningHistory = loadFromLocalStorage('learningHistory') || [];
                if (learningHistory.length === 0) {
                    addLearningMessage('ai', "Xin chào! Tôi là trợ lý học tập BA của bạn. Bạn muốn hỏi về chủ đề gì hôm nay?", true);
                } else {
                    learningChatHistoryEl.innerHTML = '';
                    learningHistory.forEach(msg => addLearningMessage(msg.role === 'user' ? 'user' : 'ai', msg.parts[0].text, true));
                    learningChatSession = geminiModel.startChat({ history: learningHistory });
                }
            }
            
            learningChatForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const userQuery = learningChatInput.value.trim();
                if (!userQuery || !geminiModel) return;

                if (!learningChatSession) {
                    learningChatSession = geminiModel.startChat();
                }

                addLearningMessage('user', userQuery);
                learningHistory.push({ role: 'user', parts: [{ text: userQuery }] });

                learningChatInput.value = '';
                const aiMessageElement = addLearningMessage('ai', '<div class="large-spinner"></div>', true);
                
                try {
                    aiMessageElement.innerHTML = '';
                    const result = await learningChatSession.sendMessageStream(userQuery);
                    const fullResponseText = await streamResponseToElement(aiMessageElement, result.stream);
                    learningHistory.push({ role: 'model', parts: [{ text: fullResponseText }] });
                    saveToLocalStorage('learningHistory', learningHistory);
                } catch (error) {
                    aiMessageElement.innerHTML = `<p><b>Lỗi:</b> ${error.message}</p>`;
                }
            });

            clearLearningHistoryBtn.addEventListener('click', resetLearningSession);


            // --- 4. "AI CASE TRAINER" LOGIC ---
            const fileInput = document.getElementById('fileInput');
            const fileUploadText = document.getElementById('file-upload-text');
            const analyzeFileButton = document.getElementById('analyzeFileButton');
            const fileUploadSection = document.getElementById('file-upload-section');
            const caseTrainerChatSection = document.getElementById('case-trainer-chat-section');
            const caseTrainerChatHistoryEl = document.getElementById('case-trainer-chat-history');
            const caseTrainerChatForm = document.getElementById('case-trainer-chat-form');
            const caseTrainerChatInput = document.getElementById('case-trainer-chat-input');
            const clearCaseTrainerHistoryBtn = document.getElementById('clear-case-trainer-history');
            let caseTrainerHistory = [];
            let caseTrainerChatSession = null;

            function addCaseTrainerMessage(sender, text, isHTML = false) {
                const messageDiv = document.createElement('div');
                messageDiv.classList.add('chat-message', sender === 'user' ? 'user-message' : 'ai-message');
                const textSpan = document.createElement('span');
                textSpan.classList.add('message-text');
                if (isHTML) {
                    textSpan.innerHTML = text;
                } else {
                    textSpan.textContent = text;
                }
                messageDiv.appendChild(textSpan);
                caseTrainerChatHistoryEl.appendChild(messageDiv);
                caseTrainerChatHistoryEl.scrollTop = caseTrainerChatHistoryEl.scrollHeight;
                return textSpan;
            }
            
            function resetCaseTrainerSession() {
                localStorage.removeItem('caseTrainerHistory');
                caseTrainerHistory = [];
                caseTrainerChatSession = null;
                caseTrainerChatHistoryEl.innerHTML = '';
                fileInput.value = ''; // Clear file input
                
                fileUploadText.textContent = 'Nhấp để chọn file CSV, Excel, PDF hoặc DOCX';
                analyzeFileButton.disabled = true;

                caseTrainerChatSection.style.display = 'none';
                fileUploadSection.style.display = 'block';
            }

            function loadCaseTrainerSession() {
                const savedHistory = loadFromLocalStorage('caseTrainerHistory');
                if (savedHistory && savedHistory.length > 0) {
                    caseTrainerHistory = savedHistory;
                    caseTrainerChatHistoryEl.innerHTML = '';
                    caseTrainerHistory.forEach(msg => {
                        // Don't display the initial long system prompt
                        if (msg.role !== 'user' || !msg.parts[0].text.startsWith('Phân tích tài liệu sau đây')) {
                            addCaseTrainerMessage(msg.role === 'user' ? 'user' : 'ai', msg.parts[0].text, true);
                        }
                    });
                    
                    caseTrainerChatSession = geminiModel.startChat({ history: caseTrainerHistory });
                    fileUploadSection.style.display = 'none';
                    caseTrainerChatSection.style.display = 'block';
                }
            }

            document.querySelector('#case-trainer .file-upload-wrapper').addEventListener('click', () => fileInput.click());
            
            fileInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file) return;
                analyzeFileButton.disabled = false;
                fileUploadText.textContent = `Đã chọn file: ${file.name}. Nhấn nút để bắt đầu.`;
            });
            
            analyzeFileButton.addEventListener('click', async () => {
                const file = fileInput.files[0];
                if (!file || !geminiModel) return;

                resetCaseTrainerSession(); // Clear previous session before starting a new one
                
                fileUploadSection.style.display = 'none';
                caseTrainerChatSection.style.display = 'block';
                const aiMessageElement = addCaseTrainerMessage('ai', 'Đang xử lý file và phân tích...', true);

                const reader = new FileReader();
                const fileExtension = file.name.split('.').pop().toLowerCase();
                
                reader.onload = async (e) => {
                    const fileContent = e.target.result;
                    let dataContext = null;

                    try {
                        if (fileExtension === 'csv') {
                            dataContext = fileContent;
                        } else if (['xlsx', 'xls'].includes(fileExtension)) {
                            const workbook = XLSX.read(fileContent, {type: 'array'});
                            dataContext = XLSX.utils.sheet_to_csv(workbook.Sheets[workbook.SheetNames[0]]);
                        } else if (fileExtension === 'pdf') {
                            const pdf = await pdfjsLib.getDocument(new Uint8Array(fileContent)).promise; let fullText = '';
                            for (let i = 1; i <= pdf.numPages; i++) { const page = await pdf.getPage(i); const textContent = await page.getTextContent(); fullText += textContent.items.map(item => item.str).join(' ') + '\n'; }
                            dataContext = fullText;
                        } else if (fileExtension === 'docx') {
                            const result = await mammoth.extractRawText({ arrayBuffer: fileContent });
                            dataContext = result.value;
                        }
                    } catch (error) {
                        aiMessageElement.innerHTML = `Lỗi khi đọc file: ${error.message}`;
                        return;
                    }


                    if(!dataContext) {
                        aiMessageElement.innerHTML = "Lỗi: Không thể đọc file hoặc định dạng không được hỗ trợ.";
                        return;
                    }

                    const initialPrompt = `Phân tích tài liệu sau đây và đưa ra nhận xét sơ bộ, các điểm chính, và 3 câu hỏi gợi mở để thảo luận. Dữ liệu: \n---${dataContext}\n---`;
                    
                    try {
                        aiMessageElement.innerHTML = '';
                        caseTrainerChatSession = geminiModel.startChat();
                        const result = await caseTrainerChatSession.sendMessageStream(initialPrompt);
                        const fullResponseText = await streamResponseToElement(aiMessageElement, result.stream);

                        caseTrainerHistory.push({ role: 'user', parts: [{ text: initialPrompt }] });
                        caseTrainerHistory.push({ role: 'model', parts: [{ text: fullResponseText }] });
                        saveToLocalStorage('caseTrainerHistory', caseTrainerHistory);

                    } catch (error) { aiMessageElement.innerHTML = `<p><b>Lỗi:</b> ${error.message}</p>`; }
                };

                if (['csv'].includes(fileExtension)) reader.readAsText(file); else reader.readAsArrayBuffer(file);
            });

            caseTrainerChatForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const userQuery = caseTrainerChatInput.value.trim();
                if (!userQuery || !geminiModel || !caseTrainerChatSession) return;
                
                addCaseTrainerMessage('user', userQuery);
                caseTrainerHistory.push({ role: 'user', parts: [{ text: userQuery }] });
                
                caseTrainerChatInput.value = '';
                const aiMessageElement = addCaseTrainerMessage('ai', '<div class="large-spinner"></div>', true);
                
                try {
                    aiMessageElement.innerHTML = '';
                    const result = await caseTrainerChatSession.sendMessageStream(userQuery);
                    const fullResponseText = await streamResponseToElement(aiMessageElement, result.stream);
                    
                    caseTrainerHistory.push({ role: 'model', parts: [{ text: fullResponseText }] });
                    saveToLocalStorage('caseTrainerHistory', caseTrainerHistory);

                } catch (error) { aiMessageElement.innerHTML = `<p><b>Lỗi:</b> ${error.message}</p>`; }
            });
            
            clearCaseTrainerHistoryBtn.addEventListener('click', resetCaseTrainerSession);


            // --- 5. "MOCK INTERVIEW" LOGIC ---
            const interviewSetupSection = document.getElementById('interview-setup-section');
            const interviewChatSection = document.getElementById('interview-chat-section');
            const startInterviewButton = document.getElementById('startInterviewButton');
            const languageBtnGroup = document.getElementById('language-btn-group');
            const topicBtnGroup = document.getElementById('topic-btn-group');
            const interviewChatHistoryEl = document.getElementById('interview-chat-history');
            const interviewChatForm = document.getElementById('interview-chat-input-form');
            const interviewChatInput = document.getElementById('interview-chat-input');
            const clearInterviewHistoryBtn = document.getElementById('clear-interview-history');
            let selectedLanguage = 'vietnamese', selectedTopic = null, speech = window.speechSynthesis, interviewChatSession = null, interviewHistory = [];

            function addInterviewMessage(sender, text, isHTML = false) {
                const messageDiv = document.createElement('div');
                messageDiv.classList.add('chat-message', sender === 'user' ? 'user-message' : 'ai-message');
                const textSpan = document.createElement('span');
                textSpan.classList.add('message-text');
                if (isHTML) {
                    textSpan.innerHTML = text;
                } else {
                    textSpan.textContent = text;
                }
                messageDiv.appendChild(textSpan);
                interviewChatHistoryEl.appendChild(messageDiv);
                interviewChatHistoryEl.scrollTop = interviewChatHistoryEl.scrollHeight;
                return textSpan;
            }
            
            function resetInterviewSession() {
                localStorage.removeItem('interviewSession');
                interviewHistory = [];
                interviewChatSession = null;
                interviewChatHistoryEl.innerHTML = '';
                speech.cancel();

                // Reset selections
                topicBtnGroup.querySelector('.selected')?.classList.remove('selected');
                selectedTopic = null;
                checkSelections();
                
                interviewChatSection.style.display = 'none';
                interviewSetupSection.style.display = 'block';
            }

            function loadInterviewSession() {
                const savedSession = loadFromLocalStorage('interviewSession');
                if(savedSession) {
                    interviewHistory = savedSession.history;
                    selectedLanguage = savedSession.language;
                    selectedTopic = savedSession.topic;

                    interviewChatHistoryEl.innerHTML = '';
                    interviewHistory.forEach(msg => {
                         // Don't display the initial long system prompt
                        if (msg.role !== 'user' || !msg.parts[0].text.startsWith('You are an experienced hiring manager')) {
                            const messageElement = addInterviewMessage(msg.role === 'user' ? 'user' : 'ai', msg.parts[0].text, true);
                             if (msg.role !== 'user') {
                                addSpeakButton(messageElement.parentElement, selectedLanguage);
                            }
                        }
                    });
                    
                    interviewChatSession = geminiModel.startChat({ history: interviewHistory });
                    interviewSetupSection.style.display = 'none';
                    interviewChatSection.style.display = 'block';
                }
            }

            function addSpeakButton(messageDiv, lang) {
                if (messageDiv.querySelector('.speak-btn')) return;
                const speakBtn = document.createElement('button');
                speakBtn.classList.add('speak-btn');
                speakBtn.innerHTML = '<i class="fa-solid fa-volume-high"></i>';
                const textForSpeech = messageDiv.querySelector('.message-text').innerText;
                speakBtn.onclick = () => speakText(textForSpeech, lang);
                messageDiv.appendChild(speakBtn);
            }
            
            function speakText(text, lang) {
                if (!speech || !text) return;
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = lang === 'vietnamese' ? 'vi-VN' : 'en-US';
                speech.cancel();
                speech.speak(utterance);
            }

            const checkSelections = () => { if(startInterviewButton) startInterviewButton.disabled = !(selectedLanguage && selectedTopic); };
            
            languageBtnGroup.addEventListener('click', (e) => { if (e.target.classList.contains('language-btn')) { languageBtnGroup.querySelector('.selected')?.classList.remove('selected'); e.target.classList.add('selected'); selectedLanguage = e.target.dataset.lang; checkSelections(); } });
            topicBtnGroup.addEventListener('click', (e) => { if (e.target.classList.contains('topic-btn')) { topicBtnGroup.querySelector('.selected')?.classList.remove('selected'); e.target.classList.add('selected'); selectedTopic = e.target.dataset.topic; checkSelections(); } });
            
            startInterviewButton.addEventListener('click', async () => {
                if (!selectedTopic || !selectedLanguage || !geminiModel) return;
                
                resetInterviewSession();

                interviewSetupSection.style.display = 'none';
                interviewChatSection.style.display = 'block';
                const aiMessageElement = addInterviewMessage('ai', '<div class="large-spinner"></div>', true);
                const initialPrompt = `You are an experienced hiring manager. **You must conduct the entire interview in ${selectedLanguage}.** Start by introducing yourself in ${selectedLanguage}. Then, ask the first question related to the topic: "${selectedTopic}". Ask only one question at a time.`;
                
                try {
                    interviewChatSession = geminiModel.startChat();
                    const result = await interviewChatSession.sendMessageStream(initialPrompt);
                    const fullResponseText = await streamResponseToElement(aiMessageElement, result.stream);
                    
                    interviewHistory.push({ role: 'user', parts: [{ text: initialPrompt }]});
                    interviewHistory.push({ role: 'model', parts: [{ text: fullResponseText }]});
                    saveToLocalStorage('interviewSession', { history: interviewHistory, language: selectedLanguage, topic: selectedTopic });
                    
                    addSpeakButton(aiMessageElement.parentElement, selectedLanguage);
                    speakText(fullResponseText, selectedLanguage);

                } catch (error) { aiMessageElement.innerHTML = `<p><b>Lỗi:</b> ${error.message}</p>`; }
            });

            interviewChatForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const userResponse = interviewChatInput.value.trim();
                if (!userResponse || !geminiModel || !interviewChatSession) return;
                
                addInterviewMessage('user', userResponse);
                interviewHistory.push({ role: 'user', parts: [{ text: userResponse }] });

                interviewChatInput.value = '';
                const aiMessageElement = addInterviewMessage('ai', '<div class="large-spinner"></div>', true);
                
                try {
                    const result = await interviewChatSession.sendMessageStream(userResponse);
                    const fullResponseText = await streamResponseToElement(aiMessageElement, result.stream);
                    
                    interviewHistory.push({ role: 'model', parts: [{ text: fullResponseText }] });
                    saveToLocalStorage('interviewSession', { history: interviewHistory, language: selectedLanguage, topic: selectedTopic });

                    addSpeakButton(aiMessageElement.parentElement, selectedLanguage);
                    speakText(fullResponseText, selectedLanguage);
                } catch (error) { aiMessageElement.innerHTML = `<p><b>Lỗi:</b> ${error.message}</p>`; }
            });
            
            clearInterviewHistoryBtn.addEventListener('click', resetInterviewSession);
            
            // --- INITIALIZE APP STATE ---
            loadLearningHistory();
            loadCaseTrainerSession();
            loadInterviewSession();
            showModule(window.location.hash || '#learning-room');
        });
    </script>
</body>
</html>
