<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BA Studio - Trợ lý AI cho sinh viên</title>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
    <!-- Libraries for file reading -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.7.0/mammoth.browser.min.js"></script>
    
    <!-- Libraries for UI and Charts -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js`;
    </script>
    <style>
        :root {
            --sidebar-bg: #1e293b;
            --main-bg: #f1f5f9;
            --text-light: #f8fafc;
            --text-dark: #334155;
            --accent-color: #3b82f6;
            --accent-hover: #2563eb;
            --user-message-bg: #e0f2fe;
            --ai-message-bg: #ffffff;
            --btn-secondary-bg: #e2e8f0;
            --danger-color: #ef4444;
            --danger-hover: #dc2626;
            --highlight-bg: #fffbeb;
            --highlight-border: #facc15;
            --highlight-icon: #f59e0b;
            --error-bg: #fee2e2;
            --error-border: #f87171;
            --error-icon: #ef4444;
        }
        body { font-family: 'Inter', sans-serif; margin: 0; background-color: var(--main-bg); color: var(--text-dark); display: flex; height: 100vh; overflow: hidden; }
        
        #auth-container { display: flex; justify-content: center; align-items: center; width: 100vw; height: 100vh; background-color: var(--main-bg); position: fixed; top: 0; left: 0; z-index: 100; }
        .auth-box { background: white; padding: 40px; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 100%; max-width: 400px; text-align: center; }
        .auth-box h2 { margin-bottom: 25px; color: var(--sidebar-bg); }
        .auth-form input { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 1rem; box-sizing: border-box; }
        .auth-form button { width: 100%; padding: 12px; margin-bottom: 15px; }
        .auth-error { color: var(--danger-color); margin-bottom: 15px; min-height: 1.2em; text-align: left; }
        .auth-toggle-link { color: var(--accent-color); cursor: pointer; text-decoration: none; }
        .auth-toggle-link:hover { text-decoration: underline; }

        #app-container { display: none; flex-direction: row; width: 100%; height: 100vh; }
        #sidebar { width: 260px; background-color: var(--sidebar-bg); color: var(--text-light); padding: 20px 0; display: flex; flex-direction: column; flex-shrink: 0; }
        #sidebar-header { padding: 0 20px 20px 20px; font-size: 1.5rem; font-weight: bold; display: flex; align-items: center; gap: 10px; }
        .nav-list { list-style: none; padding: 0; margin: 0; flex-grow: 1; }
        .nav-item a { display: flex; align-items: center; gap: 15px; padding: 15px 20px; color: var(--text-light); text-decoration: none; font-size: 1rem; transition: background-color 0.2s, border-left 0.2s; border-left: 4px solid transparent; }
        .nav-item a:hover { background-color: #334155; }
        .nav-item a.active { background-color: #475569; border-left: 4px solid var(--accent-color); font-weight: 600; }
        .nav-icon { width: 20px; text-align: center; }
        #sidebar-footer { padding: 20px; border-top: 1px solid #334155; }
        #user-info { font-size: 0.875rem; word-break: break-all; margin-bottom: 10px; }
        #logout-button { background: none; border: none; color: var(--text-light); font-size: 1rem; cursor: pointer; display: flex; align-items: center; gap: 10px; width: 100%; padding: 10px 0; font-weight: 600; }
        #logout-button:hover { color: var(--danger-color); }
        
        #center-panel { flex-grow: 1; display: flex; flex-direction: column; overflow-y: auto; }
        #main-content { flex-grow: 1; padding: 30px; width: 100%; }
        #right-panel { width: 350px; flex-shrink: 0; background-color: #ffffff; border-left: 1px solid #e2e8f0; display: flex; flex-direction: column; height: 100vh; }
        
        .module-content { display: none; }
        .module-content.active { display: block; }
        .module-header-wrapper { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .module-header { font-size: 2rem; font-weight: bold; color: var(--sidebar-bg); margin: 0; }
        .module-subheader { font-size: 1rem; color: #64748b; margin-bottom: 30px; }
        .controls-box, #analysis-hub, .chat-container { width: 100%; max-width: 800px; margin-left: auto; margin-right: auto;}
        
        .case-trainer-header {
            justify-content: flex-start;
            gap: 20px;
            align-items: center;
        }

        .header-actions {
            margin-left: auto;
            display: flex;
            gap: 10px;
        }

        button { padding: 10px 20px; background-color: var(--accent-color); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 1rem; transition: background-color 0.3s ease; display: inline-flex; align-items: center; justify-content: center; gap: 8px; font-weight: 600; }
        button:hover { background-color: var(--accent-hover); }
        button:disabled { background-color: #93c5fd; cursor: not-allowed; }
        .btn-danger { background-color: var(--danger-color); }
        .btn-danger:hover { background-color: var(--danger-hover); }
        .btn-icon { padding: 8px 12px; }
        .btn-subtle { background: none; border: none; color: var(--text-dark); padding: 5px; }
        .btn-subtle:hover { background-color: var(--main-bg); }
        
        .chat-input-form { display: flex; gap: 10px; margin-top: 20px; }
        .chat-input-form input { flex-grow: 1; padding: 12px; border: 1px solid #cbd5e1; border-radius: 4px; font-size: 16px; }
        .large-spinner { width: 40px; height: 40px; border: 5px solid #e2e8f0; border-radius: 50%; border-top-color: var(--accent-color); margin: auto; animation: spin 1s linear infinite; }
        .small-spinner { display: inline-block; width: 20px; height: 20px; border: 3px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: #fff; animation: spin 1s ease-in-out infinite; }
        .suggestion-button-group .small-spinner { border-top-color: var(--accent-color); border-left-color: var(--accent-color); border-right-color: var(--accent-color); border-bottom-color: transparent;}
        .file-upload-wrapper { cursor: pointer; border: 2px dashed #cbd5e1; padding: 30px; text-align: center; border-radius: 8px; transition: background-color 0.2s; display: block;}
        .file-upload-wrapper:hover { background-color: #f8fafc;}
        .setup-group { margin-bottom: 25px; }
        .setup-label { font-weight: 600; display: block; margin-bottom: 10px; }
        .btn-group { display: flex; flex-wrap: wrap; gap: 10px; }
        .btn-group button { background-color: var(--btn-secondary-bg); color: var(--text-dark); }
        .btn-group button.selected { background-color: var(--accent-color); color: white; }
        
        /* Right Panel Sections */
        .right-panel-section { border-bottom: 1px solid #e2e8f0; }
        .right-panel-header { padding: 20px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .right-panel-header h3 { margin: 0; font-size: 1.25rem; color: var(--sidebar-bg); flex-grow: 1;}
        .right-panel-header .toggle-icon { transition: transform 0.3s ease; }
        .right-panel-section.collapsed .toggle-icon { transform: rotate(-90deg); }
        .right-panel-content { padding: 0 20px 20px 20px; display: block; }
        .right-panel-section.collapsed .right-panel-content { display: none; }
        
        #notebook-container {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            min-height: 0; 
        }
        #notebook-content { 
            flex-grow: 1; 
            display: flex; 
            flex-direction: column; 
        }
        #scratchpad-textarea { 
            width: 100%; 
            height: 100%; 
            border: none; 
            resize: none; 
            font-family: 'Inter', sans-serif; 
            font-size: 0.95rem; 
            color: var(--text-dark); 
            line-height: 1.6; 
            background-color: transparent; 
        }
        #scratchpad-textarea:focus { outline: none; }
        
        #notebook-status { 
            font-size: 0.8rem; 
            color: #94a3b8;
            font-style: italic;
            margin-left: 10px;
            transition: color 0.3s ease; 
        }


        #session-history-list, #bookmarked-prompts-list { max-height: 300px; overflow-y: auto; }
        .history-item, .bookmark-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 8px; border-bottom: 1px solid #f1f5f9; cursor: pointer; border-radius: 4px; }
        .history-item:hover, .bookmark-item:hover { background-color: #f8fafc; }
        .history-item:last-child, .bookmark-item:last-child { border-bottom: none; }
        .history-item-info, .bookmark-item-info { display: flex; flex-direction: column; flex-grow: 1; overflow: hidden; }
        .history-item-title, .bookmark-item-text { 
            font-weight: 500; 
            color: var(--text-dark);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .history-item-date { font-size: 0.75rem; color: #64748b; }
        .history-item-actions, .bookmark-item-actions { display: flex; gap: 5px; opacity: 0; transition: opacity 0.2s; }
        .history-item:hover .history-item-actions, .bookmark-item:hover .bookmark-item-actions { opacity: 1; }
        .history-item-actions button, .bookmark-item-actions button { padding: 6px 10px; font-size: 0.8rem; }

        /* Chat Styles */
        .chat-history { height: 500px; overflow-y: auto; border: 1px solid #e2e8f0; padding: 10px; border-radius: 8px; margin-bottom: 15px; display: flex; flex-direction: column; }
        .chat-message { padding: 10px 15px; border-radius: 12px; margin-bottom: 10px; max-width: 85%; line-height: 1.5; }
        .user-message { background-color: var(--user-message-bg); align-self: flex-end; }
        .ai-message { background-color: var(--ai-message-bg); border: 1px solid #e2e8f0; align-self: flex-start; }
        .content-card-header { display: flex; justify-content: space-between; align-items: center;}
        .bookmark-btn { background: none; border: none; cursor: pointer; color: #9ca3af; padding: 5px; }
        .bookmark-btn:hover { color: #facc15; }
        .bookmark-btn.bookmarked { color: #f59e0b; }
        
        #analysis-hub-header { margin-bottom: 25px; }
        .main-insight-card, .error-card { padding: 20px; border-radius: 8px; margin-bottom: 25px; display: flex; align-items: center; gap: 15px; }
        .main-insight-card { background-color: var(--highlight-bg); border-left: 5px solid var(--highlight-border); }
        .main-insight-card i { color: var(--highlight-icon); font-size: 1.5rem; }
        .main-insight-card p { margin: 0; font-size: 1.1rem; font-weight: 500; color: #78350f; }
        .error-card { background-color: var(--error-bg); border-left: 5px solid var(--error-border); }
        .error-card i { color: var(--error-icon); font-size: 1.5rem; }
        .error-card p { margin: 0; font-weight: 500; color: #991b1b; }

        .key-metrics-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 25px; }
        .metric-card { background-color: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); text-align: center; }
        .metric-card-label { font-size: 0.875rem; color: #64748b; margin-bottom: 8px; display: block; }
        .metric-card-value { font-size: 1.5rem; font-weight: bold; color: var(--sidebar-bg); }
        
        #hub-suggestions-container { text-align: center; padding: 20px; background-color: #f8fafc; border-radius: 8px; }
        #hub-suggestions-container h3 { margin-top: 0; margin-bottom: 15px; color: var(--sidebar-bg); }
        .suggestion-button-group { display: flex; flex-direction: column; gap: 10px; }
        .suggestion-button { display: flex; justify-content: space-between; align-items: center; width: 100%; }
        .suggestion-button > button { flex-grow: 1; justify-content: flex-start; background-color: #fff; color: var(--text-dark); border: 1px solid #e2e8f0; }
        .suggestion-button > button:hover { background-color: #f1f5f9; }
        .suggestion-button > .bookmark-btn { flex-shrink: 0; margin-left: 10px; }

        
        #analysis-content-area { margin-top: 25px; display: flex; flex-direction: column; gap: 20px; }
        .content-card { background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.05); }
        .content-card h4 { margin-top: 0; color: var(--accent-color); }
        .chart-container { max-width: 100%; margin-top: 15px; }
        .speak-btn { background: none; border: none; color: #64748b; cursor: pointer; padding: 0 5px; font-size: 1rem; }

        .tab-navigation {
            display: flex;
            border-bottom: 2px solid #e2e8f0;
            margin-bottom: 20px;
        }
        .tab-link {
            padding: 10px 20px;
            cursor: pointer;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            font-size: 1rem;
            font-weight: 500;
            color: #64748b;
            margin-bottom: -2px;
            transition: color 0.2s, border-color 0.2s;
        }
        .tab-link:hover {
            color: var(--accent-color);
            background: none;
        }
        .tab-link.active {
            color: var(--accent-color);
            border-bottom-color: var(--accent-color);
            font-weight: 600;
            background: none;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        #tab-summary-content, .suggested-chart-card {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }
        #tab-summary-content h5 {
            margin-top: 20px;
            margin-bottom: 10px;
            color: var(--sidebar-bg);
        }
        #tab-summary-content ul {
            list-style: none;
            padding-left: 0;
        }
        #tab-summary-content li {
            padding: 8px 0;
            border-bottom: 1px solid #f1f5f9;
        }
        #tab-summary-content li:last-child {
            border-bottom: none;
        }
        
        .suggested-chart-card h5 {
             margin-top: 0;
             margin-bottom: 15px;
             color: var(--sidebar-bg);
        }

        @keyframes spin { 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="auth-container">
        <div class="auth-box">
            <form id="login-form" class="auth-form">
                <h2>Đăng nhập BA Studio</h2>
                <div id="login-error" class="auth-error"></div>
                <input type="email" id="login-email" placeholder="Email" required>
                <input type="password" id="login-password" placeholder="Mật khẩu" required>
                <button type="submit">Đăng nhập</button>
                <p>Chưa có tài khoản? <a href="#" id="show-signup" class="auth-toggle-link">Đăng ký ngay</a></p>
            </form>
            <form id="signup-form" class="auth-form" style="display: none;">
                <h2>Tạo tài khoản</h2>
                <div id="signup-error" class="auth-error"></div>
                <input type="email" id="signup-email" placeholder="Email" required>
                <input type="password" id="signup-password" placeholder="Mật khẩu (ít nhất 6 ký tự)" required>
                <button type="submit">Đăng ký</button>
                <p>Đã có tài khoản? <a href="#" id="show-login" class="auth-toggle-link">Đăng nhập</a></p>
            </form>
        </div>
    </div>

    <div id="app-container">
        <aside id="sidebar">
            <div id="sidebar-header"><i class="fa-solid fa-brain"></i><span>BA Studio</span></div>
            <ul class="nav-list">
                <li class="nav-item"><a href="#learning-room" class="nav-link"><i class="fa-solid fa-book-open nav-icon"></i> <span>BA Learning Room</span></a></li>
                <li class="nav-item"><a href="#case-trainer" class="nav-link"><i class="fa-solid fa-chart-simple nav-icon"></i> <span>AI Case Trainer</span></a></li>
                <li class="nav-item"><a href="#mock-interview" class="nav-link"><i class="fa-solid fa-microphone nav-icon"></i> <span>Mock Interview</span></a></li>
            </ul>
            <div id="sidebar-footer">
                <div id="user-info"></div>
                <button id="logout-button"><i class="fa-solid fa-right-from-bracket"></i> Đăng xuất</button>
            </div>
        </aside>

        <div id="center-panel">
            <main id="main-content"></main>
        </div>

        <aside id="right-panel">
            <div id="session-history-container" class="right-panel-section collapsed">
                <div class="right-panel-header" id="session-history-header">
                    <h3>Lịch Sử Phiên</h3>
                    <button class="btn-subtle toggle-icon"><i class="fa-solid fa-chevron-down"></i></button>
                </div>
                <div class="right-panel-content">
                    <div id="session-history-list">
                        <!-- History items will be injected here -->
                    </div>
                </div>
            </div>
            <!-- NEW FEATURE: Bookmarked Prompts -->
            <div id="bookmarked-prompts-container" class="right-panel-section collapsed">
                <div class="right-panel-header" id="bookmarked-prompts-header">
                    <h3>💡 Gợi ý đã lưu</h3>
                    <button class="btn-subtle toggle-icon"><i class="fa-solid fa-chevron-down"></i></button>
                </div>
                <div class="right-panel-content">
                    <div id="bookmarked-prompts-list">
                        <!-- Bookmarked prompts will be injected here -->
                    </div>
                </div>
            </div>
            <div id="notebook-container" class="right-panel-section">
                <div class="right-panel-header" id="notebook-header">
                    <h3>Sổ Tay Phân Tích</h3>
                    <span id="notebook-status"></span>
                     <button class="btn-subtle toggle-icon"><i class="fa-solid fa-chevron-down"></i></button>
                </div>
                <div class="right-panel-content" id="notebook-content">
                    <textarea id="scratchpad-textarea" placeholder="Ghi chú nhanh những insight quan trọng, ý tưởng, hoặc dàn ý tại đây..."></textarea>
                </div>
            </div>
        </aside>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, addDoc, serverTimestamp, query, getDocs, getDoc, deleteDoc, orderBy, where } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-firestore.js";
        import { getAI, getGenerativeModel } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-ai.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAP6gEJJrq0YE0lzYT-EeuskY0C1XHP9wo",
            authDomain: "bawithai.firebaseapp.com",
            projectId: "bawithai",
            storageBucket: "bawithai.appspot.com",
            messagingSenderId: "75283657811",
            appId: "1:75283657811:web:9c5c3e778396b9a340c2a6"
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        let geminiModel;
        try {
            geminiModel = getGenerativeModel(getAI(app), { model: "gemini-1.5-flash-latest" });
        } catch(e) { console.error("Could not initialize AI Model", e); }
        
        const authContainer = document.getElementById('auth-container');
        const appContainer = document.getElementById('app-container');
        const mainContent = document.getElementById('main-content');
        let currentUser = null;
        let unsubscribeListeners = [];

        onAuthStateChanged(auth, user => {
            if (user) {
                currentUser = user;
                authContainer.style.display = 'none';
                appContainer.style.display = 'flex';
                const userInfoEl = document.getElementById('user-info');
                if (userInfoEl) userInfoEl.textContent = `Chào, ${user.email}`;
                initializeAllModules();
            } else {
                currentUser = null;
                authContainer.style.display = 'flex';
                appContainer.style.display = 'none';
                cleanupOnLogout();
            }
        });
        
        document.getElementById('login-form')?.addEventListener('submit', e => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const errorDiv = document.getElementById('login-error');
            if (errorDiv) errorDiv.textContent = '';
            signInWithEmailAndPassword(auth, email, password)
                .catch(error => {
                    console.error("Login Error:", error.code);
                    if (!errorDiv) return;
                    switch (error.code) {
                        case 'auth/user-not-found':
                        case 'auth/wrong-password':
                        case 'auth/invalid-credential':
                            errorDiv.textContent = "Email hoặc mật khẩu không đúng. Vui lòng kiểm tra lại.";
                            break;
                        default:
                            errorDiv.textContent = "Đã xảy ra lỗi khi đăng nhập.";
                            break;
                    }
                });
        });
        
        document.getElementById('signup-form')?.addEventListener('submit', e => {
            e.preventDefault();
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            const errorDiv = document.getElementById('signup-error');
            if(errorDiv) errorDiv.textContent = '';
            createUserWithEmailAndPassword(auth, email, password)
                .catch(error => {
                    console.error("Signup Error:", error.code);
                    if (!errorDiv) return;
                     switch (error.code) {
                        case 'auth/email-already-in-use':
                            errorDiv.textContent = "Địa chỉ email này đã được sử dụng.";
                            break;
                        case 'auth/weak-password':
                            errorDiv.textContent = "Mật khẩu quá yếu (cần ít nhất 6 ký tự).";
                            break;
                        default:
                            errorDiv.textContent = "Đã xảy ra lỗi khi đăng ký.";
                            break;
                    }
                });
        });

        document.getElementById('logout-button')?.addEventListener('click', () => signOut(auth));
        document.getElementById('show-signup')?.addEventListener('click', e => { e.preventDefault(); document.getElementById('login-form').style.display = 'none'; document.getElementById('signup-form').style.display = 'block'; });
        document.getElementById('show-login')?.addEventListener('click', e => { e.preventDefault(); document.getElementById('login-form').style.display = 'block'; document.getElementById('signup-form').style.display = 'none'; });
        
        function initializeAllModules() {
            mainContent.innerHTML = getModulesHTML();
            setupNavigation();
            setupLearningRoom();
            setupCaseTrainer();
            setupMockInterview();
            setupRightPanel();
            showModule(window.location.hash || '#learning-room');
        }
        
        function cleanupOnLogout() {
            unsubscribeListeners.forEach(unsub => unsub());
            unsubscribeListeners = [];
            mainContent.innerHTML = '';
        }

        async function saveData(collection, moduleId, dataToSave) {
            if (!currentUser) return;
            const docRef = doc(db, 'users', currentUser.uid, collection, moduleId);
            await setDoc(docRef, dataToSave, { merge: true });
        }
        
        function getValidHistoryForChat(history) {
            if (!history || history.length === 0) return [];
            return history.filter(msg => msg.role && msg.parts && msg.parts[0] && typeof msg.parts[0].text === 'string');
        }

        function setupNavigation() {
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', e => {
                    e.preventDefault();
                    window.history.pushState(null, '', e.currentTarget.hash);
                    showModule(e.currentTarget.hash);
                });
            });
            window.addEventListener('popstate', () => showModule(window.location.hash || '#learning-room'));
        }

        function showModule(hash) {
            const targetId = hash.substring(1);
            document.querySelectorAll('.nav-link').forEach(l => l.classList.toggle('active', l.hash === hash));
            document.querySelectorAll('.module-content').forEach(c => c.classList.toggle('active', c.id === targetId));
        }
        
        function extractJson(text) {
            const match = text.match(/```json\n([\s\S]*?)\n```/);
            if (match && match[1]) return match[1];
            const startIndex = text.indexOf('{');
            const endIndex = text.lastIndexOf('}');
            if (startIndex > -1 && endIndex > -1) return text.substring(startIndex, endIndex + 1);
            return text; 
        }

        function debounce(func, delay) {
            let timeout;
            return function(...args) {
                const context = this;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), delay);
            };
        }

        function setupRightPanel() {
            document.querySelectorAll('.right-panel-header').forEach(header => {
                header.addEventListener('click', (e) => {
                    if (e.target.closest('.bookmark-btn') || e.target.id === 'notebook-status') return;
                    header.parentElement.classList.toggle('collapsed');
                });
            });
            setupScratchpad();
            setupSessionHistory();
            setupBookmarkedPrompts();
        }

        function setupScratchpad() {
            const textarea = document.getElementById('scratchpad-textarea');
            const statusEl = document.getElementById('notebook-status');
            if (!textarea || !statusEl) return;
            const moduleId = 'scratchpad';
            const collectionName = 'notebooks';
            let localContent = '';
            const debouncedSave = debounce(async (content) => {
                if (!currentUser) return;
                try {
                    await saveData(collectionName, moduleId, { content });
                    statusEl.textContent = 'Đã lưu';
                    statusEl.style.color = '#94a3b8';
                } catch (error) {
                    console.error("Error saving scratchpad:", error);
                    statusEl.textContent = 'Lỗi lưu';
                    statusEl.style.color = 'var(--danger-color)';
                }
            }, 1500);
            textarea.addEventListener('input', () => {
                localContent = textarea.value;
                statusEl.textContent = 'Đang lưu...';
                statusEl.style.color = 'var(--accent-color)';
                debouncedSave(localContent);
            });
            const docRef = doc(db, "users", currentUser.uid, collectionName, moduleId);
            const unsub = onSnapshot(docRef, (doc) => {
                const data = doc.data();
                if (data && data.content && data.content !== localContent) {
                    textarea.value = data.content;
                    localContent = data.content;
                }
                statusEl.textContent = 'Đã đồng bộ';
                statusEl.style.color = '#94a3b8';
            });
            unsubscribeListeners.push(unsub);
        }

        function setupSessionHistory() {
            const historyListEl = document.getElementById('session-history-list');
            if (!historyListEl) return;
            const archivesCollectionRef = collection(db, 'users', currentUser.uid, 'archives');
            const unsub = onSnapshot(query(archivesCollectionRef, orderBy('timestamp', 'desc')), (snapshot) => {
                historyListEl.innerHTML = '';
                if (snapshot.empty) {
                    historyListEl.innerHTML = '<p style="padding: 12px 8px; font-size: 0.85rem; color: #64748b;">Chưa có phiên nào được lưu trữ.</p>';
                    return;
                }
                snapshot.forEach(docSnap => {
                    const data = docSnap.data();
                    const itemEl = document.createElement('div');
                    itemEl.className = 'history-item';
                    const date = data.timestamp?.toDate().toLocaleString('vi-VN') || 'Không rõ ngày';
                    itemEl.innerHTML = `<div class="history-item-info"><span class="history-item-title">${data.title || 'Phiên chưa đặt tên'}</span><span class="history-item-date">${date}</span></div><div class="history-item-actions"><button class="btn-subtle btn-danger delete-history-btn" data-id="${docSnap.id}" title="Xóa vĩnh viễn phiên này"><i class="fa-solid fa-trash-can"></i></button></div>`;
                    itemEl.addEventListener('click', async (e) => {
                         if (e.target.closest('.delete-history-btn')) return;
                         const archiveId = docSnap.id;
                         const moduleToLoad = data.module || 'case-trainer';
                         if (confirm(`Bạn có muốn tải lại phiên "${data.title}" không? Phiên làm việc hiện tại sẽ được lưu trữ.`)) {
                           await loadArchivedSession(moduleToLoad, archiveId);
                        }
                    });
                    itemEl.querySelector('.delete-history-btn').addEventListener('click', async (e) => {
                        e.stopPropagation();
                        if (confirm(`Bạn có chắc muốn XÓA vĩnh viễn phiên "${data.title}" không? Hành động này không thể hoàn tác.`)) {
                            const archiveId = e.currentTarget.dataset.id;
                            const archiveDocRef = doc(db, 'users', currentUser.uid, 'archives', archiveId);
                            await deleteDoc(archiveDocRef);
                        }
                    });
                    historyListEl.appendChild(itemEl);
                });
            });
            unsubscribeListeners.push(unsub);
        }

        function setupBookmarkedPrompts() {
            const listEl = document.getElementById('bookmarked-prompts-list');
            if (!listEl) return;
            const collectionRef = collection(db, 'users', currentUser.uid, 'bookmarked_prompts');
            const unsub = onSnapshot(query(collectionRef, orderBy('savedAt', 'desc')), (snapshot) => {
                listEl.innerHTML = '';
                if (snapshot.empty) {
                    listEl.innerHTML = '<p style="padding: 12px 8px; font-size: 0.85rem; color: #64748b;">Chưa có gợi ý nào được lưu.</p>';
                    return;
                }
                snapshot.forEach(docSnap => {
                    const data = docSnap.data();
                    const itemEl = document.createElement('div');
                    itemEl.className = 'bookmark-item';
                    itemEl.innerHTML = `<div class="bookmark-item-info"><span class="bookmark-item-text">${data.promptText}</span></div><div class="bookmark-item-actions"><button class="btn-subtle btn-danger delete-bookmark-btn" title="Xóa gợi ý này"><i class="fa-solid fa-trash-can"></i></button></div>`;
                    itemEl.addEventListener('click', (e) => {
                        if (e.target.closest('.delete-bookmark-btn')) return;
                        const chatInput = document.getElementById('case-trainer-chat-input');
                        if (chatInput) {
                            chatInput.value = data.promptText;
                            chatInput.focus();
                        }
                    });
                    itemEl.querySelector('.delete-bookmark-btn').addEventListener('click', async (e) => {
                        e.stopPropagation();
                        const docRef = doc(db, 'users', currentUser.uid, 'bookmarked_prompts', docSnap.id);
                        await deleteDoc(docRef);
                    });
                    listEl.appendChild(itemEl);
                });
            });
            unsubscribeListeners.push(unsub);
        }

        async function archiveCurrentSession(moduleId) {
            if (!currentUser) return false;
            const activeSessionRef = doc(db, 'users', currentUser.uid, 'chats', moduleId);
            const activeSessionDoc = await getDoc(activeSessionRef);
            if (activeSessionDoc.exists() && activeSessionDoc.data().history?.length > 1) {
                const dataToArchive = activeSessionDoc.data();
                if (dataToArchive.activeArchiveId) return false; 
                let title = dataToArchive.fileName ? `Phân tích: ${dataToArchive.fileName}` : `Phiên lúc ${new Date().toLocaleString('vi-VN')}`;
                const archiveData = { ...dataToArchive, title: title, timestamp: serverTimestamp(), module: moduleId };
                await addDoc(collection(db, 'users', currentUser.uid, 'archives'), archiveData);
                return true;
            }
            return false;
        }

        async function loadArchivedSession(moduleId, archiveId) {
            if (!currentUser || !archiveId) return;
            await archiveCurrentSession(moduleId);
            const archiveDocRef = doc(db, 'users', currentUser.uid, 'archives', archiveId);
            const archiveDoc = await getDoc(archiveDocRef);
            if (archiveDoc.exists()) {
                const archivedData = archiveDoc.data();
                const dataToLoad = { history: archivedData.history || [], fileName: archivedData.fileName || '', activeArchiveId: archiveId };
                await setDoc(doc(db, "users", currentUser.uid, "chats", moduleId), dataToLoad);
                showModule(`#${moduleId}`);
                alert('Đã tải lại phiên làm việc. Giao diện sẽ được làm mới.');
            } else {
                console.error("Could not find archive document with ID:", archiveId);
                alert("Lỗi: Không thể tìm thấy phiên lưu trữ.");
            }
        }
        
        function setupLearningRoom() {
            const moduleId = 'learning-room';
            const historyEl = document.getElementById(`${moduleId}-chat-history`);
            const form = document.getElementById(`${moduleId}-chat-form`);
            const input = document.getElementById(`${moduleId}-chat-input`);
            const clearBtn = document.getElementById(`clear-${moduleId}-history`);
            if(!historyEl || !form || !input || !clearBtn) return;
            
            let history = [];
            let chatSession = null;
            let isThinking = false;
            const systemInstruction = {
                role: "system",
                parts: [{ text: "You are a helpful assistant for Business Analytics students. All your responses must be in Vietnamese."}]
            };

            const unsub = onSnapshot(doc(db, "users", currentUser.uid, "chats", moduleId), (doc) => {
                isThinking = false;
                if(historyEl) historyEl.innerHTML = '';
                const data = doc.data();
                history = getValidHistoryForChat((data && data.history) ? data.history : []);
                
                if(geminiModel) chatSession = geminiModel.startChat({ history, systemInstruction });

                if (history.length > 0) {
                    history.forEach(msg => {
                        const sender = msg.role === 'user' ? 'user' : 'ai';
                        const messageDiv = document.createElement('div');
                        messageDiv.className = `chat-message ${sender}-message`;
                        if (window.marked) {
                            messageDiv.innerHTML = window.marked.parse(msg.parts[0].text);
                        } else {
                            messageDiv.textContent = msg.parts[0].text;
                        }
                        if(historyEl) historyEl.appendChild(messageDiv);
                    });
                } else {
                     const aiMsgContainer = document.createElement('div');
                     aiMsgContainer.className = 'chat-message ai-message';
                     const welcomeText = "Xin chào! Tôi là trợ lý học tập BA của bạn. Bạn muốn hỏi về chủ đề gì hôm nay?";
                     if (window.marked) {
                        aiMsgContainer.innerHTML = window.marked.parse(welcomeText);
                     } else {
                        aiMsgContainer.textContent = welcomeText;
                     }
                     if(historyEl) historyEl.appendChild(aiMsgContainer);
                }
                 if(historyEl) historyEl.scrollTop = historyEl.scrollHeight;
            });
            unsubscribeListeners.push(unsub);
            
            form.addEventListener('submit', async e => {
                e.preventDefault();
                const userQuery = input.value.trim();
                if (!userQuery || !geminiModel || isThinking) return;
                
                isThinking = true;
                const submitButton = form.querySelector('button');
                const originalButtonHTML = submitButton.innerHTML;
                
                input.value = '';
                submitButton.disabled = true;
                submitButton.innerHTML = `<div class="small-spinner"></div>`;

                const historyWithUserMsg = [...history, { role: 'user', parts: [{ text: userQuery }] }];

                try {
                    await saveData("chats", moduleId, { history: historyWithUserMsg });
                    const result = await chatSession.sendMessage(userQuery);
                    const fullResponse = await result.response.text();
                    
                    const finalHistory = [...historyWithUserMsg, { role: 'model', parts: [{ text: fullResponse }] }];
                    await saveData("chats", moduleId, { history: finalHistory });
                } catch (error) {
                    console.error("Error sending message:", error);
                    const errorHistory = [...historyWithUserMsg, { role: 'model', parts: [{ text: "Lỗi: Không thể nhận phản hồi từ AI." }] }];
                    await saveData("chats", moduleId, { history: errorHistory });
                } finally {
                    isThinking = false;
                    submitButton.disabled = false;
                    submitButton.innerHTML = originalButtonHTML;
                }
            });

            clearBtn.addEventListener('click', () => {
                if (confirm("Bạn có chắc muốn xóa cuộc trò chuyện này không?")) {
                    saveData("chats", moduleId, { history: [] });
                }
            });
        }
        
        function setupMockInterview() {
            const moduleId = 'mock-interview';
            const setupSection = document.getElementById('interview-setup-section');
            const chatSection = document.getElementById('interview-chat-section');
            const historyEl = document.getElementById(`${moduleId}-chat-history`);
            const form = document.getElementById('interview-chat-input-form');
            const inputEl = document.getElementById('interview-chat-input');
            const clearBtn = document.getElementById(`clear-${moduleId}-history`);
            const startBtn = document.getElementById('startInterviewButton');
            const langGroup = document.getElementById('language-btn-group');
            const topicGroup = document.getElementById('topic-btn-group');

            if (!setupSection || !chatSection || !historyEl || !form || !inputEl || !clearBtn || !startBtn || !langGroup || !topicGroup) return;

            let sessionState = { history: [], language: 'vietnamese', topic: null, inProgress: false };
            let chatSession = null;
            let isThinking = false;

            const speech = window.speechSynthesis;
            let voices = [];
            function populateVoiceList() {
                if (typeof speechSynthesis === 'undefined') return;
                voices = speechSynthesis.getVoices();
            }
            populateVoiceList();
            if (typeof speechSynthesis !== 'undefined' && speechSynthesis.onvoiceschanged !== undefined) {
                speechSynthesis.onvoiceschanged = populateVoiceList;
            }

            function addSpeakButton(messageDiv, lang) {
                if (!messageDiv || messageDiv.querySelector('.speak-btn')) return;
                const speakBtn = document.createElement('button');
                speakBtn.className = 'speak-btn';
                speakBtn.innerHTML = '<i class="fa-solid fa-volume-high"></i>';
                speakBtn.onclick = (e) => {
                    e.stopPropagation();
                    speakText(messageDiv.innerText, lang);
                }
                messageDiv.appendChild(speakBtn);
            }
            
            function speakText(text, lang) {
                if (!speech || !text) return;
                const utterance = new SpeechSynthesisUtterance(text);
                const targetLang = lang === 'vietnamese' ? 'vi-VN' : 'en-US';
                utterance.lang = targetLang;
                let voice = voices.find(v => v.lang === targetLang && v.name.includes('Google')) || voices.find(v => v.lang === targetLang);
                if (voice) utterance.voice = voice;
                speech.cancel();
                speech.speak(utterance);
            }

            const unsub = onSnapshot(doc(db, "users", currentUser.uid, "chats", moduleId), (docSnapshot) => {
                if(historyEl) historyEl.innerHTML = '';
                isThinking = false;
                const data = docSnapshot.data();
                sessionState = data ? { ...{history:[], inProgress: false, language: 'vietnamese', topic: null}, ...data } : sessionState;
                sessionState.history = getValidHistoryForChat(sessionState.history);

                if(geminiModel) {
                    const systemInstruction = {
                        role: "system",
                        parts: [{ text: `You are an experienced hiring manager conducting an interview. You must use the ${sessionState.language} language for the entire conversation. Ask one question at a time.` }]
                    };
                    chatSession = geminiModel.startChat({ history: sessionState.history, systemInstruction });
                }

                if (sessionState.inProgress) {
                    sessionState.history.forEach(msg => {
                        if (msg.role === 'user' && msg.parts[0].text.startsWith('Start by introducing yourself')) return;

                        const senderClass = msg.role === 'user' ? 'user-message' : 'ai-message';
                        const messageDiv = document.createElement('div');
                        messageDiv.className = `chat-message ${senderClass}`;
                        if (window.marked) {
                            messageDiv.innerHTML = window.marked.parse(msg.parts[0].text);
                        } else {
                            messageDiv.textContent = msg.parts[0].text;
                        }
                        
                        if(historyEl) historyEl.appendChild(messageDiv);
                        
                        if (msg.role === 'model') {
                           addSpeakButton(messageDiv, sessionState.language);
                        }
                    });
                     if(historyEl) historyEl.scrollTop = historyEl.scrollHeight;
                    setupSection.style.display = 'none';
                    chatSection.style.display = 'block';
                } else {
                    setupSection.style.display = 'block';
                    chatSection.style.display = 'none';
                }
            });
            unsubscribeListeners.push(unsub);
            
            const checkSelections = () => { startBtn.disabled = !sessionState.topic; };
            langGroup.addEventListener('click', (e) => { 
                if (e.target.classList.contains('language-btn')) { 
                    langGroup.querySelector('.selected')?.classList.remove('selected'); 
                    e.target.classList.add('selected'); 
                    sessionState.language = e.target.dataset.lang; 
                } 
            });
            topicGroup.addEventListener('click', (e) => { 
                if (e.target.classList.contains('topic-btn')) { 
                    topicGroup.querySelector('.selected')?.classList.remove('selected'); 
                    e.target.classList.add('selected'); 
                    sessionState.topic = e.target.dataset.topic; 
                    checkSelections();
                } 
            });

            startBtn.addEventListener('click', async () => {
                if (startBtn.disabled) return;
                
                const submitButton = startBtn;
                const originalButtonHTML = submitButton.innerHTML;
                submitButton.disabled = true;
                submitButton.innerHTML = `<div class="small-spinner"></div>`;

                try {
                    const systemInstruction = { role: "system", parts: [{ text: `You are an experienced hiring manager...` }] };
                    sessionState.history = []; // Clear history before starting
                    if(geminiModel) chatSession = geminiModel.startChat({ history: [], systemInstruction });
                    
                    const initialPrompt = `Start by introducing yourself in ${sessionState.language}. Then, ask the first question related to the topic: "${sessionState.topic}".`;
                    
                    const initialHistory = [ { role: 'user', parts: [{ text: initialPrompt }] } ];
                    await saveData("chats", moduleId, { ...sessionState, history: initialHistory, inProgress: true });
                    
                    const result = await chatSession.sendMessage(initialPrompt);
                    const fullResponseText = await result.response.text();
                    
                    const finalHistory = [...initialHistory, { role: 'model', parts: [{ text: fullResponseText }] } ];
                    await saveData("chats", moduleId, { history: finalHistory });
                    speakText(fullResponseText, sessionState.language);
                } catch (error) {
                    console.error("Error starting interview:", error);
                    await saveData("chats", moduleId, { history: [], inProgress: false, topic: null });
                } finally {
                    submitButton.disabled = false;
                    submitButton.innerHTML = originalButtonHTML;
                }
            });

            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                const userResponse = inputEl.value.trim();
                if (!userResponse || !chatSession || isThinking) return;
                
                isThinking = true;
                const submitButton = form.querySelector('button');
                const originalButtonHTML = submitButton.innerHTML;
                inputEl.value = '';
                submitButton.disabled = true;
                submitButton.innerHTML = `<div class="small-spinner"></div>`;

                const historyWithUserMsg = [...sessionState.history, { role: 'user', parts: [{ text: userResponse }] }];
                await saveData("chats", moduleId, { history: historyWithUserMsg });

                try {
                    const result = await chatSession.sendMessage(userResponse);
                    const fullResponseText = await result.response.text();
                    const finalHistory = [...historyWithUserMsg, { role: 'model', parts: [{ text: fullResponseText }] }];
                    await saveData("chats", moduleId, { history: finalHistory });
                    speakText(fullResponseText, sessionState.language);
                } catch (error) {
                    console.error("Error in mock interview chat:", error);
                    const errorHistory = [...historyWithUserMsg, { role: 'model', parts: [{ text: "Lỗi: Không thể nhận phản hồi." }] }];
                    await saveData("chats", moduleId, { history: errorHistory });
                } finally {
                    isThinking = false;
                    submitButton.disabled = false;
                    submitButton.innerHTML = originalButtonHTML;
                }
            });

            clearBtn.addEventListener('click', () => {
                if (confirm("Bạn có chắc muốn kết thúc buổi phỏng vấn này không?")) {
                    speech.cancel();
                    topicGroup.querySelector('.selected')?.classList.remove('selected');
                    startBtn.disabled = true;
                    saveData("chats", moduleId, { history: [], inProgress: false, topic: null });
                }
            });
        }
        
        // =====================================================================
        // === AI CASE TRAINER - UPDATED LOGIC =================================
        // =====================================================================
        function setupCaseTrainer() {
            const moduleId = 'case-trainer';
            const uploadSection = document.getElementById('file-upload-section');
            const progressContainer = document.getElementById('analysis-progress-container');
            const progressStatusText = document.getElementById('progress-status-text');
            const progressStatusDetail = document.getElementById('progress-status-detail');
            const analysisHub = document.getElementById('analysis-hub');
            const fileInput = document.getElementById('fileInput');
            const fileUploadText = document.getElementById('file-upload-text');
            const analyzeBtn = document.getElementById('analyzeFileButton');
            const langGroup = document.getElementById('case-trainer-language-btn-group');
            const form = document.getElementById('case-trainer-chat-form');
            const inputEl = document.getElementById('case-trainer-chat-input');
            const contentArea = document.getElementById('analysis-content-area');
            const clearBtn = document.getElementById('clear-case-trainer-history');
            const exportBtn = document.getElementById('export-analysis-btn');

            if(!uploadSection || !analysisHub || !fileInput || !form || !clearBtn || !progressContainer) return;

            let history = [];
            let currentFileName = '';
            let chatSession = null;
            let selectedLanguage = 'vietnamese';
            let isThinking = false; 
            let currentArchiveId = null; 
            let bookmarkedPrompts = new Set(); 
            let bookmarkedDocs = new Map();
            
            const updateProgress = (mainText, detailText = '') => {
                if (progressStatusText) progressStatusText.textContent = mainText;
                if (progressStatusDetail) progressStatusDetail.textContent = detailText;
            };

            const bookmarksCollectionRef = collection(db, 'users', currentUser.uid, 'bookmarked_prompts');
            const unsubBookmarks = onSnapshot(bookmarksCollectionRef, (snapshot) => {
                bookmarkedPrompts.clear();
                bookmarkedDocs.clear();
                snapshot.forEach(doc => {
                    const text = doc.data().promptText;
                    bookmarkedPrompts.add(text);
                    bookmarkedDocs.set(text, doc.id);
                });
                document.querySelectorAll('.bookmark-btn[data-prompt]').forEach(btn => {
                    const prompt = btn.dataset.prompt;
                    const isBookmarked = bookmarkedPrompts.has(prompt);
                    const icon = btn.querySelector('i');
                    icon.classList.toggle('fa-solid', isBookmarked);
                    icon.classList.toggle('fa-regular', !isBookmarked);
                    btn.classList.toggle('bookmarked', isBookmarked);
                    btn.title = isBookmarked ? "Bỏ lưu gợi ý" : "Lưu lại gợi ý này";
                });
            });
            unsubscribeListeners.push(unsubBookmarks);

            async function toggleBookmark(promptText) {
                if (!promptText) return;
                const isBookmarked = bookmarkedPrompts.has(promptText);
                if (isBookmarked) {
                    const docId = bookmarkedDocs.get(promptText);
                    if (docId) {
                       await deleteDoc(doc(db, 'users', currentUser.uid, 'bookmarked_prompts', docId));
                    }
                } else {
                    await addDoc(bookmarksCollectionRef, {
                        promptText: promptText,
                        module: 'case-trainer',
                        savedAt: serverTimestamp()
                    });
                }
            }

            langGroup.addEventListener('click', (e) => { if(e.target.classList.contains('language-btn')){langGroup.querySelector('.selected')?.classList.remove('selected'); e.target.classList.add('selected'); selectedLanguage = e.target.dataset.lang;} });
            
            function showAnalysisError(message) {
                 const analyzeBtn = document.getElementById('analyzeFileButton');
                 if(analyzeBtn) {
                    analyzeBtn.disabled = fileInput.files.length === 0;
                    analyzeBtn.innerHTML = `<span>Bắt đầu Phân tích</span>`;
                 }

                if (progressContainer.style.display !== 'none') {
                     updateProgress('Lỗi Phân Tích!', message);
                     setTimeout(() => {
                        progressContainer.style.display = 'none';
                        uploadSection.style.display = 'block';
                     }, 3000);
                } else {
                    const mainInsightContainer = document.querySelector('#analysis-hub .main-insight-card-container');
                    if(mainInsightContainer) {
                        mainInsightContainer.innerHTML = `<div class="error-card"><i class="fa-solid fa-triangle-exclamation"></i><p>${message}</p></div>`;
                        document.getElementById('analysis-hub-key-metrics-grid').innerHTML = '';
                        document.getElementById('hub-suggestions-group').innerHTML = '';
                    }
                }
            }

            function addContentCard(title, isHTML = false, content = '', textToBookmark = '') {
                if (!contentArea) return null;
                const card = document.createElement('div');
                card.className = 'content-card';
                const header = document.createElement('div');
                header.className = 'content-card-header';
                const titleEl = document.createElement('h4');
                titleEl.textContent = title;
                header.appendChild(titleEl);

                if (textToBookmark) {
                    const bookmarkBtn = document.createElement('button');
                    bookmarkBtn.className = 'bookmark-btn';
                    bookmarkBtn.dataset.prompt = textToBookmark;
                    const isBookmarked = bookmarkedPrompts.has(textToBookmark);
                    bookmarkBtn.innerHTML = `<i class="fa-${isBookmarked ? 'solid' : 'regular'} fa-star"></i>`;
                    if (isBookmarked) bookmarkBtn.classList.add('bookmarked');
                    bookmarkBtn.title = isBookmarked ? "Bỏ lưu gợi ý" : "Lưu lại gợi ý này";
                    bookmarkBtn.onclick = (e) => {
                        e.stopPropagation();
                        toggleBookmark(textToBookmark);
                    };
                    header.appendChild(bookmarkBtn);
                }
                card.appendChild(header);
                const contentEl = document.createElement('div');
                if (isHTML) contentEl.innerHTML = content;
                else contentEl.textContent = content;
                card.appendChild(contentEl);
                contentArea.appendChild(card);
                card.scrollIntoView({ behavior: 'smooth', block: 'end' });
                return { card, contentEl };
            }

            function renderChart(canvasElement, chartData) {
                if (!canvasElement) return;
                const chartConfig = JSON.parse(JSON.stringify(chartData));

                if (chartConfig.type === 'horizontalBar') {
                    chartConfig.type = 'bar';
                    if (!chartConfig.options) chartConfig.options = {};
                    chartConfig.options.indexAxis = 'y';
                }

                if (chartConfig.options?.scales?.y) {
                    chartConfig.options.scales.y.ticks = {
                        ...chartConfig.options.scales.y.ticks,
                        callback: function(value) {
                            return value.toLocaleString('vi-VN');
                        }
                    };
                }

                const ctx = canvasElement.getContext('2d');
                const existingChart = Chart.getChart(ctx);
                if (existingChart) existingChart.destroy();
                new Chart(ctx, chartConfig);
            }

            function processFollowUpResponse(container, responseText) {
                 container.innerHTML = '';
                const chartRegex = /<chart>([\s\S]*?)<\/chart>/;
                const chartMatch = responseText.match(chartRegex);
                if (chartMatch && chartMatch[1]) {
                    try {
                        const chartJsonString = chartMatch[1];
                        const chartData = JSON.parse(chartJsonString);
                        const canvas = document.createElement('canvas');
                        container.appendChild(canvas);
                        renderChart(canvas, chartData);
                        const remainingText = responseText.replace(chartRegex, '').trim();
                        if (remainingText) {
                            const textEl = document.createElement('div');
                            if (window.marked) {
                                textEl.innerHTML = window.marked.parse(remainingText);
                            } else {
                                textEl.textContent = remainingText;
                            }
                            container.prepend(textEl);
                        }
                        return;
                    } catch (e) {
                        console.error("Error parsing/rendering chart:", e, "Chart data received:", chartMatch[1]);
                        container.innerHTML = `<div class="error-card"><i class="fa-solid fa-triangle-exclamation"></i><p>Lỗi khi tạo biểu đồ. AI đã trả về dữ liệu không hợp lệ.</p></div>`;
                        return;
                    }
                }
                try {
                    const cleanedJson = extractJson(responseText);
                    const responseObj = JSON.parse(cleanedJson);
                    if (responseObj.title && Array.isArray(responseObj.sections)) {
                        let htmlContent = '';
                        responseObj.sections.forEach(section => {
                            if (section.heading) htmlContent += `<h5>${section.heading}</h5>`;
                            if (section.content) {
                                if (window.marked) {
                                    htmlContent += window.marked.parse(section.content);
                                } else {
                                    htmlContent += `<p>${section.content}</p>`;
                                }
                            }
                        });
                        container.innerHTML = htmlContent;
                        return;
                    }
                } catch (e) { /* Fall through */ }
                if (window.marked) {
                    container.innerHTML = window.marked.parse(responseText);
                } else {
                    container.textContent = responseText;
                }
            }
            
            function populateAnalysisHub(responseObj) {
                try {
                    const mainInsightContainer = document.querySelector('#analysis-hub .main-insight-card-container');
                    if (mainInsightContainer) {
                        mainInsightContainer.innerHTML = `<div class="main-insight-card"><i class="fa-solid fa-star"></i><p id="analysis-hub-main-insight-text"></p></div>`;
                        const mainInsightEl = document.getElementById('analysis-hub-main-insight-text');
                        if(mainInsightEl && responseObj.mainInsight) mainInsightEl.textContent = responseObj.mainInsight;
                    }
                    const metricsGrid = document.getElementById('analysis-hub-key-metrics-grid');
                    if (metricsGrid && responseObj.keyMetrics) {
                        metricsGrid.innerHTML = '';
                        responseObj.keyMetrics.forEach(metric => {
                            const card = document.createElement('div');
                            card.className = 'metric-card';
                            card.innerHTML = `<span class="metric-card-label">${metric.label}</span><span class="metric-card-value">${metric.value}</span>`;
                            metricsGrid.appendChild(card);
                        });
                    }
                    const suggestionsGroup = document.getElementById('hub-suggestions-group');
                    if (suggestionsGroup && responseObj.curatedSuggestions) {
                        suggestionsGroup.innerHTML = '';
                        responseObj.curatedSuggestions.forEach(sugg => {
                            const wrapper = document.createElement('div');
                            wrapper.className = 'suggestion-button';
                            const button = document.createElement('button');
                            let icon = '❓';
                            if (sugg.type === 'chart') icon = '📈';
                            else if (sugg.type === 'deep-dive') icon = '🔬';
                            button.innerHTML = `<span>${icon}</span> ${sugg.text}`;
                            button.onclick = (e) => { if (isThinking) return; form.dispatchEvent(new CustomEvent('submit', { detail: { query: sugg.text, sourceButton: e.currentTarget } })); };
                            wrapper.appendChild(button);
                            const bookmarkBtn = document.createElement('button');
                            bookmarkBtn.className = 'bookmark-btn btn-subtle';
                            bookmarkBtn.dataset.prompt = sugg.text;
                            const isBookmarked = bookmarkedPrompts.has(sugg.text);
                            bookmarkBtn.innerHTML = `<i class="fa-${isBookmarked ? 'solid' : 'regular'} fa-star"></i>`;
                            if (isBookmarked) bookmarkBtn.classList.add('bookmarked');
                            bookmarkBtn.title = isBookmarked ? "Bỏ lưu gợi ý" : "Lưu lại gợi ý này";
                            bookmarkBtn.onclick = () => toggleBookmark(sugg.text);
                            wrapper.appendChild(bookmarkBtn);
                            suggestionsGroup.appendChild(wrapper);
                        });
                    }

                    const summaryContainer = document.getElementById('tab-summary');
                    if (summaryContainer && responseObj.dataSummary) {
                        const summary = responseObj.dataSummary;
                        let summaryHTML = `<div id="tab-summary-content">`;
                        summaryHTML += `<h4>Tổng quan Dữ liệu</h4>`;
                        summaryHTML += `<p><strong>Số dòng:</strong> ${summary.rowCount ? summary.rowCount.toLocaleString('vi-VN') : 'N/A'}</p>`;
                        summaryHTML += `<p><strong>Số cột:</strong> ${summary.columnCount || 'N/A'}</p>`;
                        if (summary.columns && Array.isArray(summary.columns) && summary.columns.length > 0) {
                            summaryHTML += `<h5>Các cột dữ liệu:</h5><ul>`;
                            summary.columns.forEach(col => {
                                summaryHTML += `<li><strong>${col.name || 'N/A'}:</strong> <em>${col.type || 'N/A'}</em></li>`;
                            });
                            summaryHTML += `</ul>`;
                        }
                        summaryHTML += `</div>`;
                        summaryContainer.innerHTML = summaryHTML;
                    }

                    const chartsContainer = document.getElementById('tab-charts');
                    if (chartsContainer) {
                        chartsContainer.innerHTML = ''; // Clear previous charts
                        if (responseObj.suggestedCharts && Array.isArray(responseObj.suggestedCharts) && responseObj.suggestedCharts.length > 0) {
                            responseObj.suggestedCharts.forEach((chartConfig, index) => {
                                const chartCard = document.createElement('div');
                                chartCard.className = 'suggested-chart-card';
                                
                                const chartTitle = document.createElement('h5');
                                chartTitle.textContent = chartConfig.options?.plugins?.title?.text || `Biểu đồ gợi ý ${index + 1}`;
                                chartCard.appendChild(chartTitle);

                                const canvas = document.createElement('canvas');
                                chartCard.appendChild(canvas);
                                
                                chartsContainer.appendChild(chartCard);
                                renderChart(canvas, chartConfig);
                            });
                        } else {
                            chartsContainer.innerHTML = `<p style="text-align: center; color: #64748b; padding: 20px;">AI không tìm thấy biểu đồ nào phù hợp để gợi ý tự động.</p>`;
                        }
                    }

                } catch(e) {
                     console.error("Error populating analysis hub:", e);
                     showAnalysisError("AI trả về dữ liệu không hợp lệ để hiển thị.");
                }
            }
            
            const unsub = onSnapshot(doc(db, "users", currentUser.uid, "chats", moduleId), (docSnapshot) => {
                if (contentArea) contentArea.innerHTML = '';
                isThinking = false;
                const data = docSnapshot.data();
                const sessionExists = data && data.history && data.history.length > 0;
                currentArchiveId = (data && data.activeArchiveId) ? data.activeArchiveId : null;
                currentFileName = data?.fileName || '';
                history = getValidHistoryForChat(sessionExists ? data.history : []);
                if (geminiModel) chatSession = geminiModel.startChat({ history });

                if (sessionExists) {
                    try {
                        const initialAnalysisMsg = history.find(msg => msg.role === 'model' && msg.parts[0].text.includes('"mainInsight"'));
                        if (initialAnalysisMsg) {
                            const jsonString = extractJson(initialAnalysisMsg.parts[0].text);
                            const responseObj = JSON.parse(jsonString);
                            populateAnalysisHub(responseObj);
                        }
                        history.forEach((msg, index) => {
                            if (msg.role === 'user' && msg.parts[0].text.includes('You are an expert Business Analyst assistant')) return;
                            if (msg.role === 'model' && msg.parts[0].text.includes('"mainInsight"')) return;
                            if (msg.role === 'user') {
                                addContentCard(`Câu hỏi của bạn:`, false, msg.parts[0].text, msg.parts[0].text);
                            } else if (msg.role === 'model') {
                                let userQuestionMsg = "Phản hồi của AI";
                                let textToBookmark = '';
                                for(let i = index - 1; i >= 0; i--) {
                                    if(history[i].role === 'user' && !history[i].parts[0].text.includes('You are an expert Business Analyst assistant')) {
                                        userQuestionMsg = history[i].parts[0].text;
                                        textToBookmark = history[i].parts[0].text;
                                        break;
                                    }
                                }
                                const { contentEl } = addContentCard(userQuestionMsg, true, '', textToBookmark);
                                if (contentEl) processFollowUpResponse(contentEl, msg.parts[0].text);
                            }
                        });
                    } catch (e) {
                        console.error("Error processing history:", e);
                        showAnalysisError("Lỗi khi tải lại phiên làm việc. Dữ liệu có thể bị hỏng.");
                    }
                    uploadSection.style.display = 'none';
                    analysisHub.style.display = 'block';
                    progressContainer.style.display = 'none'; 
                } else {
                    uploadSection.style.display = 'block';
                    analysisHub.style.display = 'none';
                    progressContainer.style.display = 'none'; 
                }
            });
            unsubscribeListeners.push(unsub);
            
            fileInput?.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file) return;
                if(analyzeBtn) analyzeBtn.disabled = false;
                if(fileUploadText) fileUploadText.textContent = `Đã chọn file: ${file.name}.`;
            });
            
            const tabContainer = document.querySelector(`#${moduleId} .tab-navigation`);
            if (tabContainer) {
                tabContainer.addEventListener('click', (e) => {
                    if (e.target.matches('.tab-link')) {
                        const tabId = e.target.dataset.tab;
                        
                        tabContainer.querySelector('.active').classList.remove('active');
                        e.target.classList.add('active');
                        
                        document.querySelectorAll(`#${moduleId} .tab-content`).forEach(content => {
                            content.classList.toggle('active', content.id === tabId);
                        });
                    }
                });
            }

            analyzeBtn?.addEventListener('click', async () => {
                const originalBtnHTML = analyzeBtn.innerHTML;
                try {
                    if (!fileInput.files[0]) {
                        throw new Error("Vui lòng chọn một file để phân tích.");
                    }
                    
                    analyzeBtn.disabled = true;
                    analyzeBtn.innerHTML = `<span><div class="small-spinner"></div> Đang xử lý...</span>`;

                    uploadSection.style.display = 'none';
                    progressContainer.style.display = 'block';
                    updateProgress('Bước 1/4: Đang xử lý file...');

                    await archiveCurrentSession(moduleId);
                    const file = fileInput.files[0];

                    const objective = document.getElementById('analysisObjective').value.trim();

                    await saveData("chats", moduleId, { history: [], fileName: file.name, activeArchiveId: null });
                    const reader = new FileReader();
                    reader.onload = async (e) => {
                        let dataContext = '';
                        try {
                            const fileContent = e.target.result;
                            const fileExtension = file.name.split('.').pop().toLowerCase();
                            if (['csv', 'txt'].includes(fileExtension)) { dataContext = fileContent; }
                            else if (['xlsx', 'xls'].includes(fileExtension)) { const wb = XLSX.read(fileContent, {type:'array'}); wb.SheetNames.forEach(sn => { dataContext += `--- SHEET: ${sn} ---\n${XLSX.utils.sheet_to_csv(wb.Sheets[sn])}\n`; }); }
                            else if (fileExtension === 'pdf') { const pdf = await pdfjsLib.getDocument(new Uint8Array(fileContent)).promise; for (let i = 1; i <= pdf.numPages; i++) { const page = await pdf.getPage(i); const tc = await page.getTextContent(); dataContext += tc.items.map(item => item.str).join(' ') + '\n'; } }
                            else if (fileExtension === 'docx') { const res = await mammoth.extractRawText({arrayBuffer: fileContent}); dataContext = res.value; }
                        } catch (err) { 
                            showAnalysisError(`Lỗi khi đọc file: ${err.message}`); 
                            await saveData("chats", moduleId, { history:[], fileName:'', activeArchiveId: null }); 
                            return; 
                        }
                        if (!dataContext) { 
                            showAnalysisError("Không thể đọc file hoặc định dạng không được hỗ trợ."); 
                            await saveData("chats", moduleId, { history:[], fileName:'', activeArchiveId: null }); 
                            return; 
                        }

                        updateProgress('Bước 2/4: Đã đọc file. Gửi dữ liệu đến AI...', 'Việc này có thể mất một chút thời gian...');
                        
                        const initialPrompt = `You are an expert Business Analyst assistant. Your response language MUST be ${selectedLanguage}.
Analyze the following data based on the user's objective.
USER OBJECTIVE: "${objective || 'Provide a general analysis'}"
DATA:
---
${dataContext.substring(0, 100000)}
---
CRITICAL INSTRUCTION: Your entire output MUST be ONLY the raw text of a single, strictly valid JSON object. Do not include \`\`\`json, any conversational text, introductions, or explanations. The JSON object is the only thing you should output. It must have these exact keys: "mainInsight" (String), "keyMetrics" (Array of {label: String, value: String}), "curatedSuggestions" (Array of {type: String, text: String}), "dataSummary" (an object with keys "rowCount" (Number), "columnCount" (Number), and "columns" which is an Array of Objects, each with "name" (String) and "type" (String, e.g., "Numeric", "Text", "Date")), and "suggestedCharts" (an Array of 1 to 2 valid, 100% serializable Chart.js (v3+) JSON chart configurations that are most relevant to the data. Do NOT include any functions or non-serializable elements).
The JSON response must be in the ${selectedLanguage} language.`;
                        
                        let responseText = '';
                        chatSession = geminiModel.startChat();
                        try {
                            const result = await chatSession.sendMessage(initialPrompt);
                            updateProgress('Bước 3/4: AI đã phản hồi. Đang xử lý kết quả...');
                            responseText = await result.response.text();
                            const cleanedJsonString = extractJson(responseText);
                            JSON.parse(cleanedJsonString); 
                            updateProgress('Bước 4/4: Hoàn tất! Đang hiển thị kết quả...');
                            
                            await saveData("chats", moduleId, { history: [{ role: 'user', parts: [{ text: initialPrompt }] }, { role: 'model', parts: [{ text: cleanedJsonString }] }], fileName: file.name });
                            
                            setTimeout(() => {
                                progressContainer.style.display = 'none';
                            }, 1000);

                        } catch (err) { 
                            console.error("Error initial analysis:", err, "Raw AI response:", responseText);
                            showAnalysisError("AI trả về phản hồi không hợp lệ. Vui lòng thử lại."); 
                            await saveData("chats", moduleId, { history:[], fileName:'', activeArchiveId: null }); 
                        }
                    };

                    reader.onerror = () => {
                        showAnalysisError('Lỗi nghiêm trọng khi đọc file. Không thể tiếp tục.');
                    };

                    if (['csv', 'txt'].includes(file.name.split('.').pop().toLowerCase())) reader.readAsText(file); else reader.readAsArrayBuffer(file);
                } catch (err) {
                    console.error("Analysis failed:", err);
                    showAnalysisError(`Không thể bắt đầu phân tích: ${err.message}`);
                }
            });
            
            form.addEventListener('submit', async e => {
                e.preventDefault();
                const userQuery = e.detail?.query || inputEl.value.trim();
                if (!userQuery || !chatSession || isThinking) return;
                
                isThinking = true;
                const submitButton = form.querySelector('button');
                const originalButtonHTML = submitButton.innerHTML;
                const suggestionsGroup = document.getElementById('hub-suggestions-group');
                submitButton.disabled = true;
                submitButton.innerHTML = `<div class="small-spinner"></div>`;
                if(suggestionsGroup) suggestionsGroup.querySelectorAll('button').forEach(btn => btn.disabled = true);
                if (!e.detail?.query) {
                    inputEl.value = '';
                }

                const historyWithUserMsg = [...history, { role: 'user', parts: [{ text: userQuery }] }];
                await saveData("chats", moduleId, { history: historyWithUserMsg });
                 
                try {
                    const result = await chatSession.sendMessage(userQuery);
                    const fullResponseText = await result.response.text();
                    const finalHistory = [...historyWithUserMsg, { role: 'model', parts: [{ text: fullResponseText }] }];
                    await saveData("chats", moduleId, { history: finalHistory });
                } catch (err) {
                    console.error("Error case trainer chat:", err);
                    const errorHistory = [...historyWithUserMsg, { role: 'model', parts: [{ text: "Lỗi: Không thể nhận phản hồi." }] }];
                    await saveData("chats", moduleId, { history: errorHistory });
                } finally {
                    isThinking = false;
                    submitButton.disabled = false;
                    submitButton.innerHTML = originalButtonHTML;
                    const currentSuggestionsGroup = document.getElementById('hub-suggestions-group');
                    if(currentSuggestionsGroup) currentSuggestionsGroup.querySelectorAll('button').forEach(btn => btn.disabled = false);
                }
            });
            
            async function exportAnalysis() {
                if (history.length === 0) {
                    alert("Không có nội dung để xuất.");
                    return;
                }

                let markdownContent = `# Báo cáo Phân tích: ${currentFileName}\n\n`;

                const initialAnalysisMsg = history.find(msg => msg.role === 'model' && msg.parts[0].text.includes('"mainInsight"'));
                if (initialAnalysisMsg) {
                    try {
                        const initialData = JSON.parse(extractJson(initialAnalysisMsg.parts[0].text));
                        markdownContent += `## 🚀 Insight Chính\n\n`;
                        markdownContent += `> ${initialData.mainInsight}\n\n`;
                        
                        markdownContent += `## 📊 Các Chỉ số Chính\n\n`;
                        initialData.keyMetrics.forEach(metric => {
                            markdownContent += `- **${metric.label}:** ${metric.value}\n`;
                        });
                        markdownContent += `\n`;
                    } catch (e) {
                        console.error("Không thể phân tích dữ liệu ban đầu để xuất.", e);
                    }
                }

                markdownContent += `## 💬 Lịch sử Hỏi & Đáp\n\n`;

                history.forEach(msg => {
                    if (msg.role === 'user' && msg.parts[0].text.includes('You are an expert Business Analyst assistant')) {
                        return;
                    }
                    if (msg.role === 'model' && msg.parts[0].text.includes('"mainInsight"')) {
                        return;
                    }

                    if (msg.role === 'user') {
                        markdownContent += `### 🧑‍💻 Câu hỏi của bạn:\n${msg.parts[0].text}\n\n`;
                    } else if (msg.role === 'model') {
                        let aiResponse = msg.parts[0].text;
                        if(aiResponse.includes('<chart>')) {
                            aiResponse = "[Một biểu đồ đã được tạo trong ứng dụng]\n";
                        } else {
                            try {
                               const parsedResponse = JSON.parse(extractJson(aiResponse));
                               if (parsedResponse.title && parsedResponse.sections) {
                                   let deepDiveText = `**${parsedResponse.title}**\n\n`;
                                   parsedResponse.sections.forEach(sec => {
                                       deepDiveText += `**${sec.heading}**\n${sec.content}\n\n`;
                                   });
                                   aiResponse = deepDiveText;
                               }
                            } catch(e) {
                                // Plain markdown
                            }
                        }
                        markdownContent += `### 🤖 Phản hồi của AI:\n${aiResponse}\n\n---\n\n`;
                    }
                });

                const blob = new Blob([markdownContent], { type: 'text/markdown;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `BA_Studio_Report_${currentFileName.split('.')[0] || 'analysis'}.md`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }

            exportBtn?.addEventListener('click', exportAnalysis);

             clearBtn.addEventListener('click', async () => {
                const isUpdating = currentArchiveId !== null;
                let message = "Bạn có muốn LƯU TRỮ phiên làm việc này và bắt đầu một phiên mới không?";
                let sessionTitle = "phiên hiện tại";
                if (isUpdating) {
                    const archiveDocRef = doc(db, 'users', currentUser.uid, 'archives', currentArchiveId);
                    try {
                        const archiveDoc = await getDoc(archiveDocRef);
                        if (archiveDoc.exists()) sessionTitle = `"${archiveDoc.data().title}"`;
                    } catch (e) { console.error("Could not fetch title", e); }
                    message = `Bạn có muốn CẬP NHẬT những thay đổi vào ${sessionTitle} và bắt đầu lại không?`;
                }
                if (!confirm(message)) return;
                const activeSessionRef = doc(db, 'users', currentUser.uid, 'chats', moduleId);
                const activeSessionDoc = await getDoc(activeSessionRef);
                const hasContentToSave = activeSessionDoc.exists() && activeSessionDoc.data().history?.length > 1;
                if (hasContentToSave) {
                    const dataToSave = activeSessionDoc.data();
                    if (isUpdating) {
                        const archiveDocRef = doc(db, 'users', currentUser.uid, 'archives', currentArchiveId);
                        await setDoc(archiveDocRef, { ...dataToSave, timestamp: serverTimestamp() }, { merge: true });
                        alert(`Đã cập nhật phiên ${sessionTitle}.`);
                    } else {
                        let title = dataToSave.fileName ? `Phân tích: ${dataToSave.fileName}` : `Phiên lúc ${new Date().toLocaleString('vi-VN')}`;
                        const archiveData = { ...dataToSave, title: title, timestamp: serverTimestamp(), module: moduleId };
                        delete archiveData.activeArchiveId;
                        await addDoc(collection(db, 'users', currentUser.uid, 'archives'), archiveData);
                        alert("Phiên làm việc đã được lưu trữ.");
                    }
                } else {
                    alert(isUpdating ? `Không có thay đổi để cập nhật cho ${sessionTitle}.` : "Không có nội dung để lưu trữ. Bắt đầu phiên mới.");
                }
                await saveData("chats", moduleId, { history: [], fileName: '', activeArchiveId: null });
                fileInput.value = '';
                if(fileUploadText) fileUploadText.textContent = 'Nhấp để chọn file CSV, Excel, PDF hoặc DOCX';
                
                const analyzeBtn = document.getElementById('analyzeFileButton');
                if(analyzeBtn) {
                    analyzeBtn.disabled = true;
                    analyzeBtn.innerHTML = '<span>Bắt đầu Phân tích</span>';
                }

                if (document.getElementById('analysisObjective')) document.getElementById('analysisObjective').value = '';
            });
        }
        
        function getModulesHTML() {
            return `
            <div id="learning-room" class="module-content">
                <div class="module-header-wrapper"><h1 class="module-header">BA Learning Room</h1><button id="clear-learning-room-history" class="btn-icon btn-danger" title="Bắt đầu lại"><i class="fa-solid fa-trash-can"></i></button></div>
                <p class="module-subheader">Trò chuyện với trợ lý AI để tìm hiểu sâu về các khái niệm Business Analytics.</p>
                <div class="chat-container">
                   <div class="chat-history" id="learning-room-chat-history"></div>
                   <form id="learning-room-chat-form" class="chat-input-form"><input type="text" id="learning-room-chat-input" placeholder="Ví dụ: Giải thích về A/B Testing..." autocomplete="off"><button type="submit">Gửi</button></form>
                </div>
            </div>
            <div id="case-trainer" class="module-content">
                 <div class="module-header-wrapper case-trainer-header">
                    <h1 class="module-header">AI Case Trainer</h1>
                    <div class="header-actions">
                        <button id="export-analysis-btn" class="btn-icon" title="Tải xuống báo cáo"><i class="fa-solid fa-download"></i></button>
                        <button id="clear-case-trainer-history" class="btn-icon" title="Lưu trữ hoặc Cập nhật phiên và Bắt đầu lại"><i class="fa-solid fa-floppy-disk"></i></button>
                    </div>
                 </div>
                 <p class="module-subheader">Tải lên file dữ liệu và để AI trở thành trợ lý phân tích của bạn.</p>
                 
                 <div id="file-upload-section" class="controls-box">
                    <div class="setup-group">
                        <span class="setup-label">Chọn ngôn ngữ phân tích:</span>
                        <div id="case-trainer-language-btn-group" class="btn-group">
                            <button class="language-btn selected" data-lang="vietnamese">Tiếng Việt</button>
                            <button class="language-btn" data-lang="english">English</button>
                        </div>
                    </div>
                    <label for="fileInput" class="file-upload-wrapper"><i class="fa-solid fa-cloud-arrow-up fa-2x"></i> <br><span id="file-upload-text">Nhấp để chọn file CSV, Excel, PDF hoặc DOCX</span></label>
                    <input type="file" id="fileInput" accept=".csv, .xlsx, .xls, .pdf, .docx, .txt" style="display: none;">

                    <div class="setup-group" style="margin-top: 15px; text-align: left;">
                        <label for="analysisObjective" class="setup-label">Mục tiêu phân tích (Không bắt buộc):</label>
                        <textarea id="analysisObjective" 
                                  placeholder="Ví dụ: Tìm ra các sản phẩm bán chạy nhất và phân tích xu hướng doanh thu theo tháng..." 
                                  style="width: 100%; box-sizing: border-box; min-height: 70px; border-radius: 4px; border: 1px solid #cbd5e1; padding: 10px; font-size: 15px; font-family: 'Inter', sans-serif; resize: vertical;"></textarea>
                    </div>

                    <button id="analyzeFileButton" disabled style="margin-top: 20px; width: 100%;"><span>Bắt đầu Phân tích</span></button>
                 </div>

                 <div id="analysis-progress-container" class="controls-box" style="display: none; text-align: center; padding: 40px 0;">
                    <div class="large-spinner" style="margin-bottom: 20px;"></div>
                    <h3 id="progress-status-text" style="color: var(--sidebar-bg); margin-bottom: 10px;">Đang khởi động...</h3>
                    <p id="progress-status-detail" style="color: #64748b;"></p>
                </div>

                 <div id="analysis-hub" style="display: none;">
                    <div id="analysis-hub-header">
                        <div class="main-insight-card-container">
                            <div class="main-insight-card">
                                <div class="large-spinner"></div>
                                <p>Đang tìm kiếm insight nổi bật...</p>
                            </div>
                        </div>
                        <div id="analysis-hub-key-metrics-grid" class="key-metrics-grid"></div>
                    </div>

                    <div class="tab-navigation">
                        <button class="tab-link active" data-tab="tab-overview">Tổng quan & Gợi ý</button>
                        <button class="tab-link" data-tab="tab-summary">Tóm tắt Dữ liệu</button>
                        <button class="tab-link" data-tab="tab-charts">Biểu đồ Gợi ý</button>
                    </div>

                    <div id="tab-content-container">
                        <div id="tab-overview" class="tab-content active">
                            <div id="hub-suggestions-container">
                                <h3>Bạn muốn khám phá điều gì tiếp theo?</h3>
                                <div id="hub-suggestions-group" class="suggestion-button-group"></div>
                            </div>
                        </div>
                        <div id="tab-summary" class="tab-content">
                            <!-- Nội dung tóm tắt sẽ được render vào đây -->
                        </div>
                        <div id="tab-charts" class="tab-content">
                            <!-- Biểu đồ gợi ý sẽ được render vào đây -->
                        </div>
                    </div>

                    <div id="analysis-content-area"></div>

                    <form id="case-trainer-chat-form" class="chat-input-form">
                        <input type="text" id="case-trainer-chat-input" placeholder="Hoặc, tự đặt câu hỏi của bạn..." autocomplete="off">
                        <button type="submit">Gửi</button>
                    </form>
                 </div>
            </div>
            <div id="mock-interview" class="module-content">
                <div class="module-header-wrapper"><h1 class="module-header">Mock Interview</h1><button id="clear-mock-interview-history" class="btn-icon btn-danger" title="Bắt đầu lại"><i class="fa-solid fa-trash-can"></i></button></div>
                 <p class="module-subheader">Luyện tập phỏng vấn với nhà tuyển dụng AI.</p>
                 <div id="interview-setup-section" class="controls-box">
                    <div class="setup-group"><span class="setup-label">1. Chọn ngôn ngữ:</span><div id="language-btn-group" class="btn-group"><button class="language-btn selected" data-lang="vietnamese">Tiếng Việt</button><button class="language-btn" data-lang="english">English</button></div></div>
                    <div class="setup-group"><span class="setup-label">2. Chọn chủ đề:</span><div id="topic-btn-group" class="btn-group"><button class="topic-btn" data-topic="Business Case">Tình huống Kinh doanh</button><button class="topic-btn" data-topic="SQL">Kiến thức SQL</button><button class="topic-btn" data-topic="Storytelling">Kể chuyện bằng Dữ liệu</button></div></div>
                    <button id="startInterviewButton" disabled style="width: 100%; margin-top: 10px;">Bắt đầu Phỏng vấn</button>
                 </div>
                 <div id="interview-chat-section" class="chat-container" style="display: none;">
                    <div class="chat-history" id="mock-interview-chat-history"></div>
                    <form id="interview-chat-input-form" class="chat-input-form"><input type="text" id="interview-chat-input" placeholder="Nhập câu trả lời của bạn..." autocomplete="off"><button type="submit">Gửi</button></form>
                 </div>
            </div>
            `;
        }
    </script>
</body>
</ht
